<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Hudheel-Bile </title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/js/all.min.js"></script>
    <link rel="icon" href="./Gemini_Generated_Image_kzm9l5kzm9l5kzm9.png">
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;500;600;700&display=swap"
        rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        primary: '#10B981',
                        'primary-dark': '#059669',
                        'primary-light': '#D1FAE5',
                        surface: '#F3F4F6',
                        sidebar: '#1F1D2B', // Legacy
                        'sidebar-active': '#EA7C69', // Legacy
                    },
                    fontFamily: {
                        sans: ['"Plus Jakarta Sans"', 'sans-serif'],
                    }
                }
            }
        }
    </script>
    <style>
        body {
            font-family: 'Plus Jakarta Sans', sans-serif;
            -webkit-tap-highlight-color: transparent;
        }

        .hide-scrollbar::-webkit-scrollbar {
            display: none;
        }

        .hide-scrollbar {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }

        @keyframes slideUp {
            from {
                transform: translateY(20px);
                opacity: 0;
            }

            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
            }

            to {
                opacity: 1;
            }
        }

        .animate-slide-up {
            animation: slideUp 0.3s ease-out forwards;
        }

        .animate-fade-in {
            animation: fadeIn 0.3s ease-out forwards;
        }

        .active-table-card {
            border-color: #10B981;
            background-color: #ECFDF5;
        }

        .dark .active-table-card {
            background-color: rgba(16, 185, 129, 0.1);
            border-color: #10B981;
        }

        /* Mobile Cart Transitions */
        .cart-mobile-hidden {
            transform: translateX(100%);
        }

        .cart-mobile-visible {
            transform: translateX(0);
        }

        /* Sidebar Transitions */
        .sidebar-mobile-hidden {
            transform: translateX(-100%);
        }

        .sidebar-mobile-visible {
            transform: translateX(0);
        }
    </style>
</head>

<body
    class="bg-gray-100 dark:bg-gray-900 text-gray-800 dark:text-gray-100 h-screen w-screen overflow-hidden selection:bg-primary-light selection:text-primary-dark transition-colors duration-300">

    <!-- LOGIN SCREEN (Overlay) -->
    <div id="login-screen" class="fixed inset-0 z-50 bg-gray-50 flex items-center justify-center p-4">
        <div
            class="bg-white w-full max-w-4xl rounded-[2rem] shadow-2xl overflow-hidden flex flex-col md:flex-row animate-slide-up max-h-screen md:h-[600px] overflow-y-auto md:overflow-hidden">
            <!-- Left Side Image -->
            <div
                class="w-full md:w-1/2 bg-primary relative hidden md:block overflow-hidden h-48 md:h-full flex-shrink-0">
                <img src="https://images.unsplash.com/photo-1546069901-ba9599a7e63c?q=80&w=1000&auto=format&fit=crop"
                    class="absolute inset-0 w-full h-full object-cover opacity-80 mix-blend-multiply">
                <div
                    class="absolute inset-0 flex flex-col items-center justify-center text-white p-8 md:p-12 text-center">
                    <div
                        class="w-16 h-16 md:w-20 md:h-20 bg-white/20 rounded-full flex items-center justify-center text-white text-3xl md:text-4xl mb-4 md:mb-6 backdrop-blur-md border border-white/30">
                        <i class="fa-solid fa-leaf"></i>
                    </div>
                    <h1 class="text-3xl md:text-4xl font-bold mb-2 md:mb-4">Hudheel-Bile</h1>
                    <p class="text-primary-light text-base md:text-lg">Fresh Food, Fast Service.</p>
                </div>
            </div>

            <!-- Right Side Login -->
            <div class="w-full md:w-1/2 p-6 sm:p-8 md:p-12 flex flex-col justify-center">
                <div class="mb-6 md:mb-8 text-center md:text-left">
                    <h2 class="text-2xl font-bold text-gray-800">Welcome Back</h2>
                    <p class="text-gray-400">Please select your role to continue</p>
                </div>

                <div class="space-y-4 md:space-y-6">
                    <!-- Role Selection -->
                    <div class="grid grid-cols-2 sm:grid-cols-3 gap-3 md:gap-4">
                        <button onclick="selectLoginRole('Admin')"
                            class="role-btn p-3 md:p-4 rounded-2xl border border-gray-100 bg-gray-50 hover:border-primary hover:bg-primary-light/30 transition-all flex flex-col items-center gap-2 md:gap-3 group cursor-pointer"
                            data-role="Admin">
                            <div
                                class="w-8 h-8 md:w-10 md:h-10 rounded-full bg-white shadow-sm flex items-center justify-center text-gray-400 group-hover:text-primary transition-colors text-sm md:text-base">
                                <i class="fa-solid fa-user-tie"></i>
                            </div>
                            <span
                                class="text-xs md:text-sm font-semibold text-gray-600 group-hover:text-primary-dark">Admin</span>
                        </button>
                        <button onclick="selectLoginRole('Waiter')"
                            class="role-btn p-3 md:p-4 rounded-2xl border border-gray-100 bg-gray-50 hover:border-primary hover:bg-primary-light/30 transition-all flex flex-col items-center gap-2 md:gap-3 group cursor-pointer"
                            data-role="Waiter">
                            <div
                                class="w-8 h-8 md:w-10 md:h-10 rounded-full bg-white shadow-sm flex items-center justify-center text-gray-400 group-hover:text-primary transition-colors text-sm md:text-base">
                                <i class="fa-solid fa-bell-concierge"></i>
                            </div>
                            <span
                                class="text-xs md:text-sm font-semibold text-gray-600 group-hover:text-primary-dark">Waiter</span>
                        </button>
                        <button onclick="selectLoginRole('Chef')"
                            class="role-btn p-3 md:p-4 rounded-2xl border border-gray-100 bg-gray-50 hover:border-primary hover:bg-primary-light/30 transition-all flex flex-col items-center gap-2 md:gap-3 group cursor-pointer"
                            data-role="Chef">
                            <div
                                class="w-8 h-8 md:w-10 md:h-10 rounded-full bg-white shadow-sm flex items-center justify-center text-gray-400 group-hover:text-primary transition-colors text-sm md:text-base">
                                <i class="fa-solid fa-fire-burner"></i>
                            </div>
                            <span
                                class="text-xs md:text-sm font-semibold text-gray-600 group-hover:text-primary-dark">Chef</span>
                        </button>
                        <button onclick="selectLoginRole('Manager')"
                            class="role-btn p-3 md:p-4 rounded-2xl border border-gray-100 bg-gray-50 hover:border-primary hover:bg-primary-light/30 transition-all flex flex-col items-center gap-2 md:gap-3 group cursor-pointer"
                            data-role="Manager">
                            <div
                                class="w-8 h-8 md:w-10 md:h-10 rounded-full bg-white shadow-sm flex items-center justify-center text-gray-400 group-hover:text-primary transition-colors text-sm md:text-base">
                                <i class="fa-solid fa-briefcase"></i>
                            </div>
                            <span
                                class="text-xs md:text-sm font-semibold text-gray-600 group-hover:text-primary-dark">Manager</span>
                        </button>
                        <button onclick="selectLoginRole('Cashier')"
                            class="role-btn p-3 md:p-4 rounded-2xl border border-gray-100 bg-gray-50 hover:border-primary hover:bg-primary-light/30 transition-all flex flex-col items-center gap-2 md:gap-3 group cursor-pointer"
                            data-role="Cashier">
                            <div
                                class="w-8 h-8 md:w-10 md:h-10 rounded-full bg-white shadow-sm flex items-center justify-center text-gray-400 group-hover:text-primary transition-colors text-sm md:text-base">
                                <i class="fa-solid fa-cash-register"></i>
                            </div>
                            <span
                                class="text-xs md:text-sm font-semibold text-gray-600 group-hover:text-primary-dark">Cashier</span>
                        </button>
                    </div>

                    <!-- User Selection -->
                    <div id="user-selection-container" class="hidden animate-fade-in">
                        <label class="block text-sm font-bold text-gray-700 mb-2 pl-1">Select User Account</label>
                        <div class="relative">
                            <select id="login-user-select"
                                class="w-full bg-white border border-gray-200 rounded-xl py-3 pl-4 pr-10 focus:outline-none focus:ring-2 focus:ring-primary appearance-none font-medium text-gray-700 cursor-pointer shadow-sm">
                                <!-- Options injected by JS -->
                            </select>
                            <i
                                class="fa-solid fa-chevron-down absolute right-4 top-1/2 -translate-y-1/2 text-gray-400 pointer-events-none"></i>
                        </div>
                    </div>

                    <!-- PIN Input -->
                    <div class="relative">
                        <i class="fa-solid fa-lock absolute left-5 top-1/2 -translate-y-1/2 text-gray-400"></i>
                        <input type="password" id="login-pin" placeholder="Enter PIN (1234)"
                            class="w-full bg-gray-50 border border-gray-200 rounded-xl py-4 pl-12 pr-4 focus:outline-none focus:ring-2 focus:ring-primary transition-all font-mono text-lg tracking-widest text-center shadow-inner text-gray-800">
                    </div>

                    <button onclick="handleLogin()"
                        class="w-full bg-primary hover:bg-primary-dark text-white font-bold py-4 rounded-xl shadow-lg shadow-primary/30 transition-all active:scale-95 flex items-center justify-center gap-2">
                        <span>Login</span>
                        <i class="fa-solid fa-arrow-right"></i>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- MOBILE SIDEBAR OVERLAY -->
    <div id="sidebar-overlay" onclick="toggleSidebar()"
        class="fixed inset-0 bg-black/50 z-30 hidden lg:hidden backdrop-blur-sm transition-opacity"></div>

    <!-- MAIN APP CONTAINER -->
    <div id="app-container" class="flex h-screen hidden bg-[#F8F9FD] dark:bg-gray-900 transition-colors duration-300">

        <!-- SIDEBAR -->
        <aside id="main-sidebar"
            class="sidebar-mobile-hidden lg:sidebar-mobile-visible fixed inset-y-0 left-0 z-40 w-64 bg-white dark:bg-gray-800 flex flex-col py-6 px-4 lg:m-4 rounded-r-[2rem] lg:rounded-[2rem] shadow-2xl lg:shadow-sm flex-shrink-0 transition-transform duration-300 ease-in-out lg:static lg:transform-none">
            <!-- Logo -->
            <div class="flex items-center gap-3 px-4 mb-10">
                <div
                    class="w-10 h-10 bg-primary/10 rounded-xl flex items-center justify-center text-primary text-xl shadow-sm">
                    <i class="fa-solid fa-leaf"></i>
                </div>
                <div>
                    <h1 class="font-bold text-lg leading-tight text-gray-800 dark:text-white">Hudheel<br>Bile Pro </h1>
                </div>
                <!-- Close Button Mobile -->
                <button onclick="toggleSidebar()" class="ml-auto lg:hidden text-gray-400 hover:text-gray-600">
                    <i class="fa-solid fa-xmark text-2xl"></i>
                </button>
            </div>

            <!-- Navigation -->
            <nav class="flex flex-col gap-2 md:gap-3 w-full flex-1 overflow-y-auto hide-scrollbar" id="nav-menu">
                <!-- Nav items injected by JS -->
            </nav>

            <!-- Bottom Section (Settings, User, Logout) -->
            <div class="mt-auto pt-4 border-t border-gray-100 dark:border-gray-700 flex flex-col gap-2">

                <!-- Settings Button -->
                <button onclick="switchView('settings')" data-view="settings" id="settings-btn"
                    class="nav-item w-full flex items-center gap-3 px-4 py-3 rounded-xl text-gray-500 dark:text-gray-300 hover:text-primary dark:hover:text-primary transition-all font-medium group hidden">
                    <div
                        class="w-10 h-10 rounded-xl flex items-center justify-center text-xl transition-colors icon-container">
                        <i class="fa-solid fa-gear"></i>
                    </div>
                    <span data-i18n="nav_settings">Settings</span>
                </button>

                <!-- User Profile -->
                <div
                    class="flex items-center gap-3 p-3 rounded-2xl bg-gray-50 dark:bg-gray-700 cursor:pointer hover:bg-gray-100 dark:hover:bg-gray-600 transition-colors mt-2">
                    <img src="https://ui-avatars.com/api/?name=User&background=10B981&color=fff" id="user-avatar"
                        class="w-10 h-10 rounded-full object-cover">
                    <div class="flex-1 min-w-0">
                        <h4 class="text-sm font-bold text-gray-800 dark:text-white truncate" id="user-name-display">User
                            Name</h4>
                        <p class="text-xs text-gray-400 dark:text-gray-300 truncate" id="user-role-label">Role</p>
                    </div>
                </div>

                <!-- Dark Mode + Language â€” Unified Control Row -->
                <div
                    class="mx-1 mb-1 flex items-center gap-2 p-2 bg-gray-50 dark:bg-gray-700/60 rounded-2xl border border-gray-100 dark:border-gray-700">
                    <!-- Dark Mode Toggle -->
                    <button onclick="toggleDarkMode()" id="dark-mode-toggle-sidebar"
                        class="flex-1 flex items-center justify-center gap-1.5 py-2 rounded-xl transition-all hover:bg-gray-100 dark:hover:bg-gray-600 group"
                        title="Toggle Dark Mode">
                        <div
                            class="w-7 h-7 rounded-lg bg-white dark:bg-gray-800 shadow-sm flex items-center justify-center transition-colors">
                            <i id="dark-mode-icon"
                                class="fa-solid fa-moon text-xs text-gray-500 dark:text-amber-400"></i>
                        </div>
                        <span class="text-xs font-bold text-gray-500 dark:text-gray-300">Dark</span>
                    </button>

                    <!-- Divider -->
                    <div class="w-px h-6 bg-gray-200 dark:bg-gray-600 flex-shrink-0"></div>

                    <!-- Language Toggle -->
                    <div class="flex-1 flex gap-1 p-1 bg-white dark:bg-gray-800 rounded-xl shadow-sm">
                        <button id="lang-btn-en" onclick="setLanguage('en')"
                            class="flex-1 py-1.5 text-xs font-extrabold rounded-lg bg-primary text-white transition-all shadow-sm">EN</button>
                        <button id="lang-btn-so" onclick="setLanguage('so')"
                            class="flex-1 py-1.5 text-xs font-extrabold rounded-lg text-gray-400 dark:text-gray-400 hover:text-gray-700 transition-all">SO</button>
                    </div>
                </div>

                <!-- Logout Button -->
                <button onclick="logout()"
                    class="w-full flex items-center gap-3 px-4 py-3 rounded-xl text-gray-500 dark:text-gray-300 hover:text-red-500 hover:bg-red-50 dark:hover:bg-red-900/20 transition-all font-medium group"
                    id="logout-btn">
                    <div class="w-10 h-10 rounded-xl flex items-center justify-center text-xl transition-colors">
                        <i class="fa-solid fa-arrow-right-from-bracket"></i>
                    </div>
                    <span data-i18n="nav_logout">Logout</span>
                </button>
            </div>
        </aside>

        <!-- CONTENT AREA -->
        <div class="flex-1 flex gap-4 py-4 pr-4 lg:pl-0 pl-4 h-full overflow-hidden relative" id="main-content">

            <!-- POS VIEW -->
            <div id="view-pos" class="flex-1 flex flex-col lg:flex-row gap-4 h-full w-full">

                <!-- CENTER: Menu & Categories -->
                <main class="flex-1 flex flex-col h-full min-w-0">
                    <!-- Top Bar -->
                    <header class="flex items-center justify-between mb-4 lg:mb-6 flex-shrink-0">
                        <button onclick="toggleSidebar()"
                            class="p-3 bg-white dark:bg-gray-800 rounded-xl text-gray-400 hover:text-gray-800 dark:hover:text-white shadow-sm lg:hidden mr-3">
                            <i class="fa-solid fa-bars"></i>
                        </button>

                        <div
                            class="flex-1 bg-white dark:bg-gray-800 rounded-2xl shadow-sm flex items-center px-4 py-3 transition-colors duration-300 mr-2 lg:mr-4">
                            <i class="fa-solid fa-search text-gray-400 mr-3"></i>
                            <input type="text" id="search-input" placeholder="Search Product..."
                                class="flex-1 bg-transparent focus:outline-none text-sm font-medium text-gray-700 dark:text-gray-200 placeholder-gray-400 w-full min-w-0">
                        </div>

                        <!-- Admin Add Product Button -->
                        <div class="flex gap-2 flex-shrink-0">
                            <button id="add-product-btn" onclick="openAddProductModal()"
                                class="hidden w-12 h-12 bg-primary text-white rounded-2xl shadow-sm flex items-center justify-center hover:bg-primary-dark transition-colors shadow-lg shadow-primary/30">
                                <i class="fa-solid fa-plus"></i>
                            </button>
                            <button
                                class="w-12 h-12 bg-white dark:bg-gray-800 rounded-2xl shadow-sm flex items-center justify-center text-gray-600 dark:text-gray-300 hover:text-primary transition-colors hidden sm:flex">
                                <i class="fa-solid fa-sliders"></i>
                            </button>
                        </div>
                    </header>

                    <!-- Scrollable Area -->
                    <div class="flex-1 overflow-y-auto hide-scrollbar pb-24 lg:pb-20 relative">

                        <!-- Categories -->
                        <div class="flex gap-3 lg:gap-4 mb-6 overflow-x-auto hide-scrollbar pb-2"
                            id="category-container">
                            <!-- Injected JS -->
                        </div>

                        <!-- Menu Grid -->
                        <div class="grid grid-cols-2 md:grid-cols-3 xl:grid-cols-3 gap-3 lg:gap-5" id="menu-container">
                            <!-- Injected JS -->
                        </div>

                    </div>
                </main>

                <!-- RIGHT: Cart Panel (Responsive) -->
                <aside id="pos-cart-panel"
                    class="fixed inset-0 z-50 lg:z-0 w-full lg:w-[400px] lg:static bg-white dark:bg-gray-800 rounded-none lg:rounded-[2rem] shadow-2xl lg:shadow-sm flex flex-col h-full overflow-y-auto hide-scrollbar transition-transform duration-300 ease-in-out cart-mobile-hidden lg:transform-none lg:block">
                    <!-- Mobile Header for Cart -->
                    <div
                        class="sticky top-0 z-20 lg:hidden p-4 border-b border-gray-100 dark:border-gray-700 flex justify-between items-center bg-white/95 backdrop-blur-sm dark:bg-gray-800/95">
                        <h2 class="text-xl font-bold text-gray-800 dark:text-white" data-i18n="current_order">Current
                            Order</h2>
                        <button onclick="toggleMobileCart()"
                            class="w-10 h-10 rounded-full bg-gray-100 dark:bg-gray-700 flex items-center justify-center text-gray-500">
                            <i class="fa-solid fa-chevron-down"></i>
                        </button>
                    </div>

                    <!-- Header -->
                    <div class="p-6 pb-2 hidden lg:block">
                        <div class="flex justify-between items-start mb-6">
                            <div>
                                <h2 class="text-2xl font-bold text-gray-800 dark:text-white" id="cart-table-name">Table
                                    4</h2>
                                <p class="text-sm font-medium text-gray-400 dark:text-gray-500 mt-0.5"
                                    id="cart-customer-name">Floyd
                                    Miles</p>
                                <span id="cart-status-badge"
                                    class="mt-2 inline-block px-2 py-1 rounded text-xs font-bold bg-green-100 text-green-600">Occupied</span>
                            </div>
                            <button id="release-table-btn" onclick="requestReleaseTable()"
                                class="hidden items-center gap-2 px-3 py-2 rounded-xl border-2 border-red-200 bg-red-50 dark:bg-red-900/20 dark:border-red-800 text-red-500 dark:text-red-400 hover:bg-red-500 hover:border-red-500 hover:text-white dark:hover:bg-red-600 dark:hover:border-red-600 transition-all text-xs font-bold shadow-sm active:scale-95"
                                title="Release this table">
                                <i class="fa-solid fa-door-open text-sm"></i>
                                <span>Release</span>
                            </button>
                        </div>
                    </div>

                    <!-- Order Type Tabs (Visible on mobile within cart) -->
                    <div class="px-6 lg:px-6 pt-2 pb-2">
                        <div class="flex bg-gray-100 dark:bg-gray-700 p-1.5 rounded-2xl mb-4">
                            <button
                                class="flex-1 py-2.5 rounded-xl text-sm font-semibold transition-all shadow-sm bg-primary text-white order-type-btn"
                                data-type="Dine In" data-i18n="dine_in">Dine in</button>
                        </div>
                    </div>

                    <!-- Cart List -->
                    <div class="flex-1 px-6 pb-24 space-y-4" id="cart-container">
                        <!-- Injected JS -->
                    </div>

                    <!-- Footer (Sticky Floating Button Area) -->
                    <div
                        class="sticky bottom-0 z-20 p-6 bg-white/95 backdrop-blur-md dark:bg-gray-800/95 border-t border-gray-100 dark:border-gray-700 pb-8 sm:pb-6 rounded-b-none lg:rounded-b-[2rem]">
                        <div class="space-y-3 mb-6 hidden lg:block">
                            <div class="flex justify-between text-gray-500 dark:text-gray-400 text-sm">
                                <span data-i18n="sub_total">Sub Total</span>
                                <span class="font-bold text-gray-800 dark:text-white" id="subtotal-display">$0.00</span>
                            </div>
                            <div class="flex justify-between text-gray-500 dark:text-gray-400 text-sm">
                                <span data-i18n="tax">Tax 5%</span>
                                <span class="font-bold text-gray-800 dark:text-white" id="tax-display">$0.00</span>
                            </div>
                            <div class="my-3 border-t border-dashed border-gray-200 dark:border-gray-700"></div>
                            <div class="flex justify-between items-center">
                                <span class="text-lg font-bold text-gray-800 dark:text-white"
                                    data-i18n="total_amount">Total
                                    Amount</span>
                                <span class="text-2xl font-bold text-gray-800 dark:text-white"
                                    id="total-display">$0.00</span>
                            </div>
                        </div>

                        <div class="flex justify-between items-center lg:hidden mb-4">
                            <span class="text-lg font-bold text-gray-800 dark:text-white" data-i18n="total_amount">Total
                                Amount</span>
                            <span class="text-2xl font-bold text-gray-800 dark:text-white"
                                id="total-display-mobile">$0.00</span>
                        </div>

                        <!-- Payment Methods -->
                        <div class="flex gap-2 sm:gap-3 mb-6" id="payment-methods-container">
                            <button onclick="setPaymentMethod('Cash')" id="pay-cash"
                                class="payment-btn flex-1 py-3 px-2 rounded-xl border border-primary bg-primary/5 text-primary flex flex-col items-center justify-center gap-1 transition-all shadow-sm">
                                <i class="fa-solid fa-money-bill text-lg"></i>
                                <span class="text-[10px] font-bold uppercase tracking-wide"
                                    data-i18n="pay_cash">Cash</span>
                            </button>
                            <button onclick="setPaymentMethod('Card')" id="pay-card"
                                class="payment-btn flex-1 py-3 px-2 rounded-xl border border-gray-200 dark:border-gray-600 text-gray-400 hover:border-gray-300 flex flex-col items-center justify-center gap-1 transition-all shadow-sm">
                                <i class="fa-regular fa-credit-card text-lg"></i>
                                <span class="text-[10px] font-bold uppercase tracking-wide"
                                    data-i18n="pay_card">Card</span>
                            </button>
                            <button onclick="setPaymentMethod('QR')" id="pay-qr"
                                class="payment-btn flex-1 py-3 px-2 rounded-xl border border-gray-200 dark:border-gray-600 text-gray-400 hover:border-gray-300 flex flex-col items-center justify-center gap-1 transition-all shadow-sm">
                                <i class="fa-solid fa-qrcode text-lg"></i>
                                <span class="text-[10px] font-bold uppercase tracking-wide" data-i18n="pay_qr">QR
                                    Code</span>
                            </button>
                        </div>

                        <button id="main-action-btn" onclick="handleMainAction()"
                            class="w-full bg-primary hover:bg-primary-dark text-white font-bold py-4 rounded-xl shadow-xl shadow-primary/30 transition-all active:scale-95 text-sm uppercase tracking-wide"
                            data-i18n="send_to_kitchen">Send to Kitchen
                        </button>
                    </div>
                </aside>

                <!-- Mobile Floating Cart Button -->
                <button onclick="toggleMobileCart()" id="mobile-cart-btn"
                    class="lg:hidden fixed bottom-6 right-6 left-6 bg-gray-900 text-white p-4 rounded-2xl shadow-2xl flex justify-between items-center z-40 animate-slide-up">
                    <div class="flex items-center gap-3">
                        <div class="w-10 h-10 bg-gray-800 rounded-full flex items-center justify-center text-primary font-bold"
                            id="mobile-cart-count">0</div>
                        <div class="flex flex-col text-left">
                            <span class="text-xs text-gray-400" data-i18n="total">Total</span>
                            <span class="font-bold text-lg" id="mobile-cart-total">$0.00</span>
                        </div>
                    </div>
                    <div class="flex items-center gap-2 font-bold text-sm">
                        <span data-i18n="view_order">View Order</span> <i class="fa-solid fa-chevron-right"></i>
                    </div>
                </button>
            </div>

            <!-- TABLES VIEW -->
            <div id="view-tables"
                class="hidden flex-1 bg-white dark:bg-gray-800 rounded-[2rem] overflow-hidden flex flex-col h-full transition-colors duration-300">
                <div class="p-4 md:p-8 h-full overflow-y-auto">
                    <header class="flex flex-col md:flex-row md:items-center justify-between mb-6 gap-4">
                        <div class="flex items-center gap-4">
                            <button onclick="toggleSidebar()"
                                class="p-3 bg-gray-100 dark:bg-gray-700 rounded-xl lg:hidden"><i
                                    class="fa-solid fa-bars"></i></button>
                            <h1 class="text-2xl md:text-3xl font-bold text-gray-800 dark:text-white"
                                data-i18n="tables_title">Table
                                Services</h1>
                        </div>
                        <div class="flex flex-col md:flex-row md:items-center gap-4">
                            <div
                                class="flex gap-3 sm:gap-4 overflow-x-auto hide-scrollbar pb-2 md:pb-0 w-full md:w-auto">
                                <div class="flex items-center gap-2 whitespace-nowrap">
                                    <div class="w-3 h-3 rounded-full bg-gray-100 border border-gray-300"></div>
                                    <span class="text-xs sm:text-sm text-gray-500 dark:text-gray-400 font-medium"
                                        data-i18n="table_status_available">Available</span>
                                </div>
                                <div class="flex items-center gap-2 whitespace-nowrap">
                                    <div class="w-3 h-3 rounded-full bg-green-100 border border-green-500"></div>
                                    <span class="text-xs sm:text-sm text-gray-500 dark:text-gray-400 font-medium"
                                        data-i18n="table_status_occupied">Occupied</span>
                                </div>
                                <div class="flex items-center gap-2 whitespace-nowrap">
                                    <div class="w-3 h-3 rounded-full bg-blue-100 border border-blue-500"></div>
                                    <span class="text-xs sm:text-sm text-gray-500 dark:text-gray-400 font-medium"
                                        data-i18n="table_status_kitchen">Kitchen/Ready</span>
                                </div>
                                <div class="flex items-center gap-2 whitespace-nowrap">
                                    <div class="w-3 h-3 rounded-full bg-purple-100 border border-purple-500"></div>
                                    <span class="text-xs sm:text-sm text-gray-500 dark:text-gray-400 font-medium"
                                        data-i18n="table_status_payment">Waiting Payment</span>
                                </div>
                            </div>
                            <button id="add-table-btn" onclick="addNewTable()"
                                class="hidden bg-primary text-white px-4 py-2 rounded-xl text-sm font-bold shadow-sm hover:shadow-md transition-all whitespace-nowrap lg:ml-4">
                                <i class="fa-solid fa-plus mr-2"></i><span data-i18n="add_table">Add Table</span>
                            </button>
                        </div>
                    </header>

                    <div id="tables-grid"
                        class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-4 md:gap-6 pb-20">
                        <!-- Injected by JS -->
                    </div>
                </div>
            </div>

            <!-- KITCHEN VIEW -->
            <div id="view-kitchen"
                class="hidden flex-1 bg-white dark:bg-gray-900 rounded-[2rem] overflow-hidden flex flex-col text-gray-800 dark:text-white transition-colors duration-300">
                <header
                    class="h-16 md:h-20 border-b border-gray-100 dark:border-gray-800 flex flex-wrap items-center justify-between px-4 md:px-8 bg-gray-50 dark:bg-gray-800/50 backdrop-blur-md">
                    <div class="flex items-center gap-4">
                        <button onclick="toggleSidebar()"
                            class="p-2 rounded-lg bg-gray-100 dark:bg-gray-800 lg:hidden"><i
                                class="fa-solid fa-bars"></i></button>
                        <h1 class="text-xl md:text-2xl font-bold flex items-center gap-3">
                            <i class="fa-solid fa-fire-burner text-primary"></i>
                            <span data-i18n="kitchen_title">Kitchen</span>
                        </h1>
                    </div>
                    <div class="flex gap-3 sm:gap-4 text-xs md:text-sm">
                        <div
                            class="flex items-center gap-1 sm:gap-2 uppercase tracking-wide font-bold text-gray-500 dark:text-gray-300">
                            <div class="w-2 h-2 rounded-full bg-blue-500"></div> <span class="hidden sm:inline"
                                data-i18n="kitchen_sent">Sent to Kitchen</span>
                        </div>
                        <div
                            class="flex items-center gap-1 sm:gap-2 uppercase tracking-wide font-bold text-gray-500 dark:text-gray-300">
                            <div class="w-2 h-2 rounded-full bg-emerald-500"></div> <span class="hidden sm:inline"
                                data-i18n="kitchen_preparing">Preparing</span>
                        </div>
                    </div>
                </header>
                <div class="flex-1 p-4 md:p-6 overflow-y-auto custom-scrollbar">
                    <div id="kitchen-grid"
                        class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-4 md:gap-6 pb-20">
                        <!-- Tickets -->
                    </div>
                    <div id="kitchen-empty"
                        class="hidden h-full flex flex-col items-center justify-center text-gray-400 dark:text-gray-600">
                        <i class="fa-solid fa-check-circle text-6xl mb-4 text-gray-300 dark:text-gray-700"></i>
                        <p class="text-xl font-medium text-center" data-i18n="kitchen_all_done">All orders completed</p>
                    </div>
                </div>
            </div>

            <!-- ADMIN VIEW -->
            <div id="view-admin"
                class="hidden flex-1 bg-gray-50 dark:bg-gray-900 rounded-[2rem] overflow-hidden flex flex-col transition-colors duration-300">
                <div class="p-4 md:p-8 h-full overflow-y-auto hide-scrollbar">

                    <!-- Header -->
                    <header class="flex flex-col md:flex-row md:items-center justify-between gap-4 mb-6 md:mb-8">
                        <div class="flex items-center gap-4">
                            <button onclick="toggleSidebar()"
                                class="p-3 bg-white dark:bg-gray-800 rounded-xl shadow-sm lg:hidden hover:bg-gray-100 transition-colors">
                                <i class="fa-solid fa-bars text-gray-600 dark:text-gray-300"></i>
                            </button>
                            <div>
                                <div class="flex items-center gap-3 mb-1">
                                    <span
                                        class="w-2.5 h-2.5 rounded-full bg-primary shadow-lg shadow-primary/50 animate-pulse"></span>
                                    <span class="text-xs font-bold text-primary uppercase tracking-widest"
                                        data-i18n="admin_live">Live
                                        Overview</span>
                                </div>
                                <h1 class="text-2xl md:text-3xl font-black text-gray-900 dark:text-white"
                                    data-i18n="admin_title">Admin
                                    Dashboard</h1>
                                <p class="text-sm text-gray-400 mt-0.5" data-i18n="admin_subtitle">Today's performance
                                    at a glance</p>
                            </div>
                        </div>
                        <div class="flex items-center gap-3">
                            <div
                                class="hidden sm:flex items-center gap-2 bg-white dark:bg-gray-800 border border-gray-100 dark:border-gray-700 px-4 py-2 rounded-xl shadow-sm text-sm text-gray-500 dark:text-gray-400 font-medium">
                                <i class="fa-regular fa-calendar text-primary"></i>
                                <span id="admin-date-display"></span>
                            </div>
                            <button onclick="renderAdmin()"
                                class="bg-primary text-white px-4 py-2 rounded-xl text-sm font-bold shadow-md shadow-primary/30 hover:shadow-lg hover:bg-primary-dark transition-all active:scale-95 flex items-center gap-2">
                                <i class="fa-solid fa-rotate-right"></i> <span data-i18n="admin_refresh">Refresh</span>
                            </button>
                        </div>
                    </header>

                    <!-- Metrics Grid -->
                    <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4 md:gap-5 mb-6 md:mb-7">
                        <!-- Revenue Card -->
                        <div
                            class="p-5 md:p-6 rounded-3xl bg-gradient-to-br from-emerald-500 via-primary to-teal-600 text-white relative overflow-hidden shadow-xl shadow-primary/25 group hover:-translate-y-1.5 transition-all duration-300 cursor-default">
                            <div
                                class="absolute -right-6 -top-6 w-28 h-28 bg-white/10 rounded-full blur-2xl group-hover:scale-125 transition-transform duration-500">
                            </div>
                            <div class="absolute -left-4 -bottom-4 w-20 h-20 bg-white/5 rounded-full blur-xl"></div>
                            <div class="flex justify-between items-start relative z-10 mb-5">
                                <div
                                    class="w-11 h-11 rounded-2xl bg-white/25 backdrop-blur-sm flex items-center justify-center text-lg shadow-inner">
                                    <i class="fa-solid fa-dollar-sign"></i>
                                </div>
                                <span
                                    class="bg-white/20 border border-white/30 px-2.5 py-1 rounded-xl text-[10px] font-extrabold uppercase tracking-wider backdrop-blur-sm flex items-center gap-1">
                                    <i class="fa-solid fa-arrow-trend-up text-[8px]"></i> Today
                                </span>
                            </div>
                            <p class="text-white/75 text-xs font-bold uppercase tracking-widest mb-1 relative z-10"
                                data-i18n="admin_revenue">Total Revenue</p>
                            <h2 class="text-3xl md:text-4xl font-black tracking-tight relative z-10" id="admin-revenue">
                                $0.00</h2>
                        </div>

                        <!-- Orders Card -->
                        <div
                            class="p-5 md:p-6 rounded-3xl bg-gradient-to-br from-blue-400 via-blue-500 to-cyan-500 text-white relative overflow-hidden shadow-xl shadow-blue-500/25 group hover:-translate-y-1.5 transition-all duration-300 cursor-default">
                            <div
                                class="absolute -right-6 -top-6 w-28 h-28 bg-white/10 rounded-full blur-2xl group-hover:scale-125 transition-transform duration-500">
                            </div>
                            <div class="absolute -left-4 -bottom-4 w-20 h-20 bg-white/5 rounded-full blur-xl"></div>
                            <div class="flex justify-between items-start relative z-10 mb-5">
                                <div
                                    class="w-11 h-11 rounded-2xl bg-white/25 backdrop-blur-sm flex items-center justify-center text-lg shadow-inner">
                                    <i class="fa-solid fa-receipt"></i>
                                </div>
                                <span
                                    class="bg-white/20 border border-white/30 px-2.5 py-1 rounded-xl text-[10px] font-extrabold uppercase tracking-wider backdrop-blur-sm"
                                    data-i18n="today">Today</span>
                            </div>
                            <p class="text-white/75 text-xs font-bold uppercase tracking-widest mb-1 relative z-10"
                                data-i18n="admin_orders">Total Orders</p>
                            <h2 class="text-3xl md:text-4xl font-black tracking-tight relative z-10" id="admin-orders">0
                            </h2>
                        </div>

                        <!-- Avg Order Card -->
                        <div
                            class="p-5 md:p-6 rounded-3xl bg-gradient-to-br from-violet-500 via-purple-500 to-fuchsia-500 text-white relative overflow-hidden shadow-xl shadow-purple-500/25 group hover:-translate-y-1.5 transition-all duration-300 cursor-default">
                            <div
                                class="absolute -right-6 -top-6 w-28 h-28 bg-white/10 rounded-full blur-2xl group-hover:scale-125 transition-transform duration-500">
                            </div>
                            <div class="absolute -left-4 -bottom-4 w-20 h-20 bg-white/5 rounded-full blur-xl"></div>
                            <div class="flex justify-between items-start relative z-10 mb-5">
                                <div
                                    class="w-11 h-11 rounded-2xl bg-white/25 backdrop-blur-sm flex items-center justify-center text-lg shadow-inner">
                                    <i class="fa-solid fa-chart-pie"></i>
                                </div>
                                <span
                                    class="bg-white/20 border border-white/30 px-2.5 py-1 rounded-xl text-[10px] font-extrabold uppercase tracking-wider backdrop-blur-sm"
                                    data-i18n="avg">Avg</span>
                            </div>
                            <p class="text-white/75 text-xs font-bold uppercase tracking-widest mb-1 relative z-10"
                                data-i18n="admin_avg">Avg Order Value
                            </p>
                            <h2 class="text-3xl md:text-4xl font-black tracking-tight relative z-10"
                                id="admin-avg-order">$0.00</h2>
                        </div>

                        <!-- Staff Card -->
                        <div
                            class="p-5 md:p-6 rounded-3xl bg-gradient-to-br from-orange-400 via-orange-500 to-rose-500 text-white relative overflow-hidden shadow-xl shadow-orange-500/25 group hover:-translate-y-1.5 transition-all duration-300 cursor-default">
                            <div
                                class="absolute -right-6 -top-6 w-28 h-28 bg-white/10 rounded-full blur-2xl group-hover:scale-125 transition-transform duration-500">
                            </div>
                            <div class="absolute -left-4 -bottom-4 w-20 h-20 bg-white/5 rounded-full blur-xl"></div>
                            <div class="flex justify-between items-start relative z-10 mb-5">
                                <div
                                    class="w-11 h-11 rounded-2xl bg-white/25 backdrop-blur-sm flex items-center justify-center text-lg shadow-inner">
                                    <i class="fa-solid fa-users"></i>
                                </div>
                                <span
                                    class="bg-white/20 border border-white/30 px-2.5 py-1 rounded-xl text-[10px] font-extrabold uppercase tracking-wider backdrop-blur-sm">Live</span>
                            </div>
                            <p class="text-white/75 text-xs font-bold uppercase tracking-widest mb-1 relative z-10"
                                data-i18n="admin_staff">Active Staff</p>
                            <h2 class="text-3xl md:text-4xl font-black tracking-tight relative z-10"
                                id="active-staff-count">0</h2>
                        </div>
                    </div>

                    <!-- Charts Row -->
                    <div class="grid grid-cols-1 lg:grid-cols-3 gap-4 md:gap-5 mb-6 md:mb-7">
                        <!-- Chart Card -->
                        <div
                            class="lg:col-span-2 bg-white dark:bg-gray-800 rounded-3xl p-5 md:p-6 border border-gray-100 dark:border-gray-700 shadow-sm">
                            <div class="flex justify-between items-center mb-5">
                                <div>
                                    <h3
                                        class="font-bold text-base text-gray-800 dark:text-white flex items-center gap-2">
                                        <span
                                            class="w-7 h-7 rounded-lg bg-primary/10 text-primary flex items-center justify-center text-sm">
                                            <i class="fa-solid fa-chart-column"></i>
                                        </span>
                                        Revenue Analytics
                                    </h3>
                                    <p class="text-xs text-gray-400 mt-1 ml-9">Last 7 days</p>
                                </div>
                                <div
                                    class="bg-gray-50 dark:bg-gray-900/50 border border-gray-100 dark:border-gray-700 rounded-xl p-1 flex text-xs font-bold">
                                    <button class="px-3 py-1.5 bg-primary text-white shadow-sm rounded-lg">7
                                        Days</button>
                                </div>
                            </div>
                            <div class="relative w-full h-[280px]">
                                <canvas id="salesChart"></canvas>
                            </div>
                        </div>

                        <!-- Top Waiters Card -->
                        <div
                            class="bg-white dark:bg-gray-800 rounded-3xl p-5 md:p-6 border border-gray-100 dark:border-gray-700 shadow-sm flex flex-col">
                            <div class="flex items-center gap-3 mb-5">
                                <div
                                    class="w-9 h-9 rounded-xl bg-gradient-to-br from-yellow-400 to-orange-500 text-white flex items-center justify-center shadow-lg shadow-orange-500/25">
                                    <i class="fa-solid fa-trophy text-sm"></i>
                                </div>
                                <div>
                                    <h3 class="font-bold text-base text-gray-800 dark:text-white leading-tight">Top
                                        Waiters</h3>
                                    <p class="text-[10px] text-gray-400 font-bold uppercase tracking-wider">Today's
                                        Rankings</p>
                                </div>
                            </div>
                            <ul id="top-waiters-list" class="space-y-2.5 flex-1">
                                <!-- Injected by JS -->
                                <li class="flex items-center justify-center h-full text-gray-400 text-sm font-medium">No
                                    orders yet
                                    today</li>
                            </ul>
                        </div>
                    </div>

                    <!-- Staff Table Row -->
                    <div
                        class="bg-white dark:bg-gray-800 rounded-3xl border border-gray-100 dark:border-gray-700 shadow-sm overflow-hidden">
                        <div
                            class="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4 p-5 md:p-6 border-b border-gray-100 dark:border-gray-700/50">
                            <div>
                                <h3 class="font-bold text-base text-gray-800 dark:text-white flex items-center gap-2">
                                    <span
                                        class="w-7 h-7 rounded-lg bg-primary/10 text-primary flex items-center justify-center text-sm">
                                        <i class="fa-solid fa-users-gear"></i>
                                    </span>
                                    Team Management
                                </h3>
                                <p class="text-xs text-gray-400 mt-1 ml-9" data-i18n="admin_team_sub">Manage your staff
                                    roster</p>
                            </div>
                            <button id="add-staff-btn" onclick="openAddStaffModal()"
                                class="w-full sm:w-auto bg-primary text-white px-5 py-2.5 rounded-xl text-sm font-bold hover:shadow-lg hover:shadow-primary/25 transition-all flex items-center justify-center gap-2 active:scale-95">
                                <i class="fa-solid fa-user-plus text-xs"></i>
                                <span data-i18n="admin_add_staff">Add Staff</span>
                            </button>
                        </div>
                        <div class="overflow-x-auto hide-scrollbar">
                            <table class="w-full text-left text-sm text-gray-600 dark:text-gray-300 min-w-[500px]">
                                <thead
                                    class="text-[11px] uppercase tracking-wider font-bold text-gray-400 bg-gray-50 dark:bg-gray-900/40 border-b border-gray-100 dark:border-gray-700/50">
                                    <tr>
                                        <th class="px-6 py-4" data-i18n="staff_name">Name</th>
                                        <th class="px-6 py-4" data-i18n="staff_role">Role</th>
                                        <th class="px-6 py-4" data-i18n="staff_status">Status</th>
                                        <th class="px-6 py-4 text-right" data-i18n="staff_actions">Actions</th>
                                    </tr>
                                </thead>
                                <tbody class="divide-y divide-gray-50 dark:divide-gray-700/50" id="staff-table-body">
                                    <!-- Injected by JS -->
                                </tbody>
                            </table>
                        </div>
                    </div>

                </div>
            </div>


            <!-- SETTINGS VIEW -->
            <div id="view-settings"
                class="hidden flex-1 bg-gray-50 dark:bg-gray-900 rounded-[2rem] overflow-hidden flex flex-col h-full p-4 md:p-8 transition-colors duration-300">
                <header class="flex items-center gap-4 mb-6 md:mb-8">
                    <button onclick="toggleSidebar()"
                        class="p-3 bg-white shadow-sm dark:bg-gray-800 rounded-xl lg:hidden"><i
                            class="fa-solid fa-bars"></i></button>
                    <h1 class="text-2xl md:text-3xl font-bold text-gray-800 dark:text-white" data-i18n="settings_title">
                        Settings
                    </h1>
                </header>

                <div class="max-w-xl">
                    <h3 class="font-bold text-lg text-gray-800 dark:text-white mb-5 pl-1"
                        data-i18n="settings_appearance">
                        Appearance
                    </h3>

                    <div class="flex flex-col gap-5">
                        <!-- Dark Mode Toggle -->
                        <div
                            class="flex items-center justify-between bg-white dark:bg-[#1E2530] rounded-3xl p-3 pl-4 pr-5 shadow-sm border border-gray-100 dark:border-gray-800/50 transition-colors">
                            <div class="flex items-center gap-5">
                                <div
                                    class="w-14 h-14 bg-gray-50 dark:bg-[#343D4E] rounded-2xl flex items-center justify-center transition-colors">
                                    <i class="fa-solid fa-moon text-gray-600 dark:text-gray-300 text-2xl"></i>
                                </div>
                                <span class="text-gray-800 dark:text-gray-200 font-medium text-xl"
                                    data-i18n="settings_dark_mode">Dark
                                    Mode</span>
                            </div>
                            <button onclick="toggleDarkMode()" id="dark-mode-toggle-settings"
                                class="w-[4.5rem] h-10 bg-gray-300 dark:bg-primary rounded-full relative transition-colors duration-300 flex-shrink-0 cursor-pointer">
                                <div
                                    class="w-8 h-8 bg-white rounded-full absolute top-1 left-1 dark:left-[1.85rem] transition-all duration-300 shadow-sm">
                                </div>
                            </button>
                        </div>

                        <!-- Language Toggle -->
                        <div
                            class="flex bg-white dark:bg-[#343D4E] rounded-3xl p-2.5 h-[4.5rem] shadow-sm border border-gray-100 dark:border-gray-800/50 transition-colors gap-2">
                            <button id="lang-btn-settings-en" onclick="setLanguage('en')"
                                class="flex-1 rounded-2xl text-white font-bold text-xl transition-all bg-primary shadow-sm tracking-wide">EN</button>
                            <button id="lang-btn-settings-so" onclick="setLanguage('so')"
                                class="flex-1 rounded-2xl text-gray-500 dark:text-gray-300 font-bold text-xl hover:text-gray-800 dark:hover:text-white transition-all tracking-wide">SO</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- RESERVATION VIEW (Placeholder) -->
            <div id="view-reservation"
                class="hidden flex-1 bg-white dark:bg-gray-800 rounded-[2rem] overflow-hidden flex flex-col h-full p-4 md:p-8 transition-colors duration-300">
                <header class="flex items-center gap-4 mb-6 md:mb-8">
                    <button onclick="toggleSidebar()" class="p-3 bg-gray-100 dark:bg-gray-700 rounded-xl lg:hidden"><i
                            class="fa-solid fa-bars"></i></button>
                    <h1 class="text-2xl md:text-3xl font-bold text-gray-800 dark:text-white">Reservation</h1>
                </header>
                <div class="flex-1 flex flex-col items-center justify-center text-gray-400 p-4 text-center">
                    <i
                        class="fa-solid fa-calendar-check text-5xl md:text-6xl mb-4 text-gray-200 dark:text-gray-600"></i>
                    <p class="text-base md:text-lg font-medium">Reservation Module Coming Soon</p>
                </div>
            </div>

            <!-- RECEIPT VIEW (Placeholder) -->
            <div id="view-receipt"
                class="hidden flex-1 bg-white dark:bg-gray-800 rounded-[2rem] overflow-hidden flex flex-col h-full p-4 md:p-8 transition-colors duration-300">
                <header class="flex items-center gap-4 mb-6 md:mb-8">
                    <button onclick="toggleSidebar()" class="p-3 bg-gray-100 dark:bg-gray-700 rounded-xl lg:hidden"><i
                            class="fa-solid fa-bars"></i></button>
                    <h1 class="text-2xl md:text-3xl font-bold text-gray-800 dark:text-white">Receipt</h1>
                </header>
                <div class="flex-1 flex flex-col items-center justify-center text-gray-400 p-4 text-center">
                    <i class="fa-solid fa-receipt text-5xl md:text-6xl mb-4 text-gray-200 dark:text-gray-600"></i>
                    <p class="text-base md:text-lg font-medium">Receipt Module Coming Soon</p>
                </div>
            </div>

            <!-- ORDERS VIEW -->
            <div id="view-orders"
                class="hidden flex-1 bg-gray-50 dark:bg-gray-900 rounded-[2rem] overflow-hidden flex flex-col h-full p-4 md:p-8 transition-colors duration-300">
                <header class="flex items-center justify-between gap-4 mb-6 md:mb-8">
                    <div class="flex items-center gap-4">
                        <button onclick="toggleSidebar()"
                            class="p-3 bg-white shadow-sm dark:bg-gray-800 rounded-xl lg:hidden"><i
                                class="fa-solid fa-bars"></i></button>
                        <div>
                            <h1 class="text-2xl md:text-3xl font-bold text-gray-800 dark:text-white mb-1"
                                data-i18n="orders_title">
                                Orders Registry</h1>
                            <p class="text-sm text-gray-500 dark:text-gray-400" data-i18n="orders_subtitle">Track and
                                manage all
                                completed transactions.</p>
                        </div>
                    </div>
                    <div
                        class="hidden sm:flex items-center gap-3 bg-white dark:bg-gray-800 px-4 py-2 rounded-xl shadow-sm border border-gray-100 dark:border-gray-700">
                        <div class="w-2 h-2 rounded-full bg-green-500 animate-pulse"></div>
                        <span class="text-sm font-semibold text-gray-600 dark:text-gray-300"
                            data-i18n="orders_live_sync">Live
                            Sync</span>
                    </div>
                </header>

                <div class="flex-1 flex flex-col relative">
                    <!-- Gradient overlay for scroll -->
                    <div
                        class="absolute top-0 left-0 right-0 h-4 bg-gradient-to-b from-gray-50 dark:from-gray-900 to-transparent z-10 pointer-events-none">
                    </div>

                    <div class="overflow-x-auto hide-scrollbar flex-1 -mx-4 px-4 md:mx-0 md:px-0">
                        <table class="w-full text-left min-w-[800px] border-separate border-spacing-y-3">
                            <thead>
                                <tr
                                    class="text-xs uppercase tracking-wider font-bold text-gray-400 dark:text-gray-500 pb-2">
                                    <th class="px-6 py-3 font-medium" data-i18n="orders_col_details">Order Details</th>
                                    <th class="px-6 py-3 font-medium" data-i18n="orders_col_assigned">Assigned To</th>
                                    <th class="px-6 py-3 font-medium" data-i18n="orders_col_summary">Order Summary</th>
                                    <th class="px-6 py-3 font-medium text-right" data-i18n="orders_col_amount">Amount
                                        Paid</th>
                                    <th class="px-6 py-3 font-medium text-right" data-i18n="orders_col_time">Timestamp
                                    </th>
                                    <th class="px-6 py-3 font-medium text-right" data-i18n="orders_col_print">Print</th>
                                </tr>
                            </thead>
                            <tbody id="orders-table-body">
                                <!-- Injected by JS -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

        </div>
    </div>

    <!-- RECEIPT MODAL -->
    <div id="receipt-modal"
        class="hidden fixed inset-0 bg-black/60 z-50 flex flex-col items-center justify-center p-4 backdrop-blur-sm">
        <div
            class="bg-white rounded-lg shadow-2xl relative flex flex-col max-h-[90vh] w-full max-w-sm overflow-hidden animate-slide-up">

            <!-- Receipt Content -->
            <div id="printable-receipt" class="p-6 overflow-y-auto bg-white text-black font-mono text-sm">
                <div class="text-center mb-4">
                    <h2 class="text-2xl font-bold uppercase tracking-wider mb-1">Hudheel Bile</h2>
                    <p class="text-gray-500 text-xs">Tuwali</p>
                    <p class="text-gray-500 text-xs">Tel: +252 63 4308432</p>
                    <div class="mt-4 border-b border-dashed border-gray-400 pb-4 flex justify-between text-xs">
                        <span id="receipt-date"></span>
                        <span id="receipt-time"></span>
                    </div>
                </div>

                <div class="mb-4">
                    <div class="flex justify-between text-xs mb-1">
                        <span>Order: <span id="receipt-order-id" class="font-bold"></span></span>
                        <span>Table: <span id="receipt-table" class="font-bold"></span></span>
                    </div>
                    <div class="text-xs">Waiter: <span id="receipt-waiter"></span></div>
                </div>

                <table class="w-full text-left mb-4">
                    <thead>
                        <tr class="border-y border-dashed border-gray-400">
                            <th class="py-2 text-xs font-normal">Item</th>
                            <th class="py-2 text-xs font-normal text-center">Qty</th>
                            <th class="py-2 text-xs font-normal text-right">Price</th>
                        </tr>
                    </thead>
                    <tbody id="receipt-items">
                        <!-- Injected -->
                    </tbody>
                </table>

                <div class="flex justify-between text-xs mb-1">
                    <span>Subtotal</span>
                    <span id="receipt-subtotal"></span>
                </div>
                <div class="flex justify-between text-xs mb-3 border-b border-dashed border-gray-400 pb-3">
                    <span>Tax (5%)</span>
                    <span id="receipt-tax"></span>
                </div>
                <div class="flex justify-between text-lg font-bold">
                    <span>TOTAL</span>
                    <span id="receipt-total"></span>
                </div>

                <div class="text-center mt-8 text-xs text-gray-500 italic">
                    Thank you for dining with us!
                </div>
            </div>

            <!-- Payment Actions (Not Printed) -->
            <div class="bg-gray-100 p-4 border-t border-gray-200">
                <div class="flex gap-2">
                    <button onclick="closeReceiptModal()"
                        class="flex-1 py-3 text-gray-600 font-bold bg-white border border-gray-300 rounded-xl hover:bg-gray-50 transition-colors">Cancel</button>
                    <button onclick="processReceiptPayment()"
                        class="flex-1 py-3 text-white font-bold bg-green-600 hover:bg-green-700 rounded-xl shadow-lg transition-colors">Pay
                        & Print</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Add Tables Modal -->
    <div id="add-table-modal"
        class="fixed inset-0 bg-black/60 z-[60] hidden flex items-center justify-center backdrop-blur-sm p-4">
        <div id="add-table-content"
            class="bg-white dark:bg-gray-900 w-full max-w-sm rounded-[2rem] shadow-2xl overflow-hidden transform scale-95 opacity-0 transition-all duration-300 border border-gray-100 dark:border-gray-700">

            <!-- Accent Header -->
            <div class="bg-gradient-to-br from-primary to-emerald-700 px-7 pt-7 pb-10 relative overflow-hidden">
                <div class="absolute -top-6 -right-6 w-28 h-28 bg-white/10 rounded-full"></div>
                <div class="absolute -bottom-4 -left-4 w-20 h-20 bg-white/10 rounded-full"></div>
                <div class="flex justify-between items-start relative z-10">
                    <div>
                        <div class="w-10 h-10 bg-white/20 rounded-xl flex items-center justify-center mb-3">
                            <i class="fa-solid fa-table-cells text-white text-lg"></i>
                        </div>
                        <h2 class="text-2xl font-extrabold text-white" data-i18n="add_table">Add Tables</h2>
                        <p class="text-white/70 text-sm mt-1" data-i18n="prompt_add_tables">How many tables would you
                            like to add?
                        </p>
                    </div>
                    <button onclick="closeAddTableModal()"
                        class="w-9 h-9 bg-white/20 hover:bg-white/30 rounded-xl flex items-center justify-center text-white transition-colors">
                        <i class="fa-solid fa-xmark text-lg"></i>
                    </button>
                </div>
            </div>

            <!-- Form Body -->
            <div class="-mt-6 bg-white dark:bg-gray-900 rounded-t-[2rem] px-7 pt-7 pb-7 space-y-5">
                <div>
                    <label
                        class="block text-xs font-bold text-gray-500 dark:text-gray-400 uppercase tracking-wider mb-2">Number
                        of Tables</label>
                    <input type="number" id="add-table-count" value="1" min="1" max="50"
                        class="w-full px-4 py-4 rounded-xl border border-gray-200 dark:border-gray-700 bg-gray-50 dark:bg-gray-800 text-gray-800 dark:text-white text-2xl font-bold text-center focus:outline-none focus:ring-2 focus:ring-primary/50 focus:border-primary transition-all tracking-widest">
                </div>

                <div class="flex gap-3 pt-1">
                    <button onclick="closeAddTableModal()"
                        class="flex-1 py-3.5 rounded-xl border-2 border-gray-200 dark:border-gray-700 text-gray-600 dark:text-gray-300 font-bold hover:bg-gray-100 dark:hover:bg-gray-800 transition-all text-sm"
                        data-i18n="cancel">Cancel</button>
                    <button onclick="confirmAddTable()"
                        class="flex-1 py-3.5 rounded-xl bg-primary hover:bg-emerald-600 text-white font-bold shadow-lg shadow-primary/30 hover:shadow-xl hover:shadow-primary/40 transition-all active:scale-95 text-sm flex items-center justify-center gap-2">
                        <i class="fa-solid fa-plus"></i>
                        <span data-i18n="add_table">Add Tables</span>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Add/Edit Staff Modal -->
    <div id="add-staff-modal"
        class="fixed inset-0 bg-black/60 z-[60] hidden flex items-center justify-center backdrop-blur-sm transition-opacity duration-300 p-4">
        <div class="bg-white dark:bg-gray-900 w-full max-w-md rounded-[2rem] shadow-2xl overflow-hidden transform scale-95 opacity-0 transition-all duration-300 border border-gray-100 dark:border-gray-700"
            id="add-staff-content">

            <!-- Accent Header -->
            <div class="bg-gradient-to-br from-primary to-emerald-700 px-7 pt-7 pb-10 relative overflow-hidden">
                <div class="absolute -top-6 -right-6 w-28 h-28 bg-white/10 rounded-full"></div>
                <div class="absolute -bottom-4 -left-4 w-20 h-20 bg-white/10 rounded-full"></div>
                <div class="flex justify-between items-start relative z-10">
                    <div>
                        <div class="w-10 h-10 bg-white/20 rounded-xl flex items-center justify-center mb-3">
                            <i class="fa-solid fa-user-plus text-white text-lg"></i>
                        </div>
                        <h2 class="text-2xl font-extrabold text-white" id="modal-title" data-i18n="modal_add_staff">Add
                            New Staff
                        </h2>
                        <p class="text-white/70 text-sm mt-1">Fill in the details below</p>
                    </div>
                    <button onclick="closeAddStaffModal()"
                        class="w-9 h-9 bg-white/20 hover:bg-white/30 rounded-xl flex items-center justify-center text-white transition-colors">
                        <i class="fa-solid fa-xmark text-lg"></i>
                    </button>
                </div>
            </div>

            <!-- Form Body (pulled up over header) -->
            <div class="-mt-6 bg-white dark:bg-gray-900 rounded-t-[2rem] px-7 pt-7 pb-7 space-y-5">

                <!-- Full Name -->
                <div>
                    <label
                        class="block text-xs font-bold text-gray-500 dark:text-gray-400 uppercase tracking-wider mb-2"
                        data-i18n="modal_full_name">Full Name</label>
                    <input type="text" id="new-staff-name"
                        class="w-full px-4 py-3.5 rounded-xl border border-gray-200 dark:border-gray-700 bg-gray-50 dark:bg-gray-800 text-gray-800 dark:text-white placeholder-gray-400 dark:placeholder-gray-500 focus:outline-none focus:ring-2 focus:ring-primary/50 focus:border-primary transition-all"
                        placeholder="e.g. Jane Doe">
                </div>

                <!-- Role -->
                <div>
                    <label
                        class="block text-xs font-bold text-gray-500 dark:text-gray-400 uppercase tracking-wider mb-2"
                        data-i18n="modal_role">Role</label>
                    <div class="relative">
                        <select id="new-staff-role"
                            class="w-full px-4 py-3.5 rounded-xl border border-gray-200 dark:border-gray-700 bg-gray-50 dark:bg-gray-800 text-gray-800 dark:text-white focus:outline-none focus:ring-2 focus:ring-primary/50 focus:border-primary transition-all appearance-none cursor-pointer">
                            <option value="Waiter">Waiter</option>
                            <option value="Manager">Manager</option>
                            <option value="Chef">Chef</option>
                            <option value="Cashier">Cashier</option>
                        </select>
                        <i
                            class="fa-solid fa-chevron-down absolute right-4 top-1/2 -translate-y-1/2 text-gray-400 pointer-events-none text-sm"></i>
                    </div>
                </div>

                <!-- Access PIN -->
                <div>
                    <label
                        class="block text-xs font-bold text-gray-500 dark:text-gray-400 uppercase tracking-wider mb-2"
                        data-i18n="modal_pin">Access PIN</label>
                    <input type="text" id="new-staff-pin" value="1234"
                        class="w-full px-4 py-3.5 rounded-xl border border-gray-200 dark:border-gray-700 bg-gray-50 dark:bg-gray-800 text-gray-800 dark:text-white font-mono tracking-[0.5em] text-center focus:outline-none focus:ring-2 focus:ring-primary/50 focus:border-primary transition-all text-lg">
                </div>

                <!-- Buttons -->
                <div class="flex gap-3 pt-2">
                    <button onclick="closeAddStaffModal()"
                        class="flex-1 py-3.5 rounded-xl border-2 border-gray-200 dark:border-gray-700 text-gray-600 dark:text-gray-300 font-bold hover:bg-gray-100 dark:hover:bg-gray-800 transition-all text-sm"
                        data-i18n="modal_cancel">Cancel</button>
                    <button onclick="saveStaff()" id="modal-submit-btn"
                        class="flex-1 py-3.5 rounded-xl bg-primary hover:bg-emerald-600 text-white font-bold shadow-lg shadow-primary/30 hover:shadow-xl hover:shadow-primary/40 transition-all active:scale-95 text-sm"
                        data-i18n="modal_add_btn">Add Staff Member</button>
                </div>

            </div>
        </div>
    </div>

    <!-- Add/Edit Product Modal -->
    <div id="add-product-modal"
        class="fixed inset-0 bg-black/60 z-[60] hidden flex items-center justify-center backdrop-blur-sm transition-opacity duration-300 p-4">
        <div class="bg-white dark:bg-gray-900 w-full max-w-md rounded-[2rem] shadow-2xl overflow-hidden transform scale-95 opacity-0 transition-all duration-300 border border-gray-100 dark:border-gray-700"
            id="add-product-content">

            <!-- Accent Header -->
            <div class="bg-gradient-to-br from-primary to-emerald-700 px-7 pt-7 pb-10 relative overflow-hidden">
                <div class="absolute -top-6 -right-6 w-28 h-28 bg-white/10 rounded-full"></div>
                <div class="absolute -bottom-4 -left-4 w-20 h-20 bg-white/10 rounded-full"></div>
                <div class="flex justify-between items-start relative z-10">
                    <div>
                        <div class="w-10 h-10 bg-white/20 rounded-xl flex items-center justify-center mb-3">
                            <i class="fa-solid fa-utensils text-white text-lg"></i>
                        </div>
                        <h2 class="text-2xl font-extrabold text-white" id="product-modal-title">Add New Item</h2>
                        <p class="text-white/70 text-sm mt-1">Fill in the item details below</p>
                    </div>
                    <button onclick="closeAddProductModal()"
                        class="w-9 h-9 bg-white/20 hover:bg-white/30 rounded-xl flex items-center justify-center text-white transition-colors">
                        <i class="fa-solid fa-xmark text-lg"></i>
                    </button>
                </div>
            </div>

            <!-- Form Body -->
            <div class="-mt-6 bg-white dark:bg-gray-900 rounded-t-[2rem] px-7 pt-7 pb-7 space-y-5">

                <!-- Item Name -->
                <div>
                    <label
                        class="block text-xs font-bold text-gray-500 dark:text-gray-400 uppercase tracking-wider mb-2">Item
                        Name</label>
                    <input type="text" id="product-name"
                        class="w-full px-4 py-3.5 rounded-xl border border-gray-200 dark:border-gray-700 bg-gray-50 dark:bg-gray-800 text-gray-800 dark:text-white placeholder-gray-400 dark:placeholder-gray-500 focus:outline-none focus:ring-2 focus:ring-primary/50 focus:border-primary transition-all"
                        placeholder="e.g. Beef Burger">
                </div>

                <!-- Price + Category -->
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label
                            class="block text-xs font-bold text-gray-500 dark:text-gray-400 uppercase tracking-wider mb-2">Price
                            ($)</label>
                        <input type="number" id="product-price" step="0.01"
                            class="w-full px-4 py-3.5 rounded-xl border border-gray-200 dark:border-gray-700 bg-gray-50 dark:bg-gray-800 text-gray-800 dark:text-white placeholder-gray-400 dark:placeholder-gray-500 focus:outline-none focus:ring-2 focus:ring-primary/50 focus:border-primary transition-all"
                            placeholder="0.00">
                    </div>
                    <div>
                        <label
                            class="block text-xs font-bold text-gray-500 dark:text-gray-400 uppercase tracking-wider mb-2">Category</label>
                        <select id="product-category"
                            class="w-full px-4 py-3.5 rounded-xl border border-gray-200 dark:border-gray-700 bg-gray-50 dark:bg-gray-800 text-gray-800 dark:text-white focus:outline-none focus:ring-2 focus:ring-primary/50 focus:border-primary transition-all appearance-none cursor-pointer">
                            <!-- Populated by JS -->
                        </select>
                    </div>
                </div>

                <!-- Item Image Upload -->
                <div>
                    <label
                        class="block text-xs font-bold text-gray-500 dark:text-gray-400 uppercase tracking-wider mb-2">Item
                        Image</label>
                    <div class="relative group cursor-pointer">
                        <input type="file" id="product-image-file" accept="image/*"
                            class="absolute inset-0 w-full h-full opacity-0 cursor-pointer z-10"
                            onchange="previewProductImage(this)">
                        <div id="product-image-preview-container"
                            class="w-full h-32 rounded-xl border-2 border-dashed border-gray-200 dark:border-gray-700 bg-gray-50 dark:bg-gray-800 flex flex-col items-center justify-center text-gray-400 dark:text-gray-500 group-hover:border-primary group-hover:bg-primary/5 dark:group-hover:bg-primary/10 transition-all overflow-hidden relative">
                            <div id="product-image-placeholder" class="flex flex-col items-center gap-2">
                                <div
                                    class="w-12 h-12 bg-gray-100 dark:bg-gray-700 rounded-xl flex items-center justify-center group-hover:bg-primary/10 transition-colors">
                                    <i
                                        class="fa-solid fa-cloud-arrow-up text-xl text-gray-400 dark:text-gray-500 group-hover:text-primary transition-colors"></i>
                                </div>
                                <span class="text-xs font-medium text-gray-500 dark:text-gray-400">Click or drag to
                                    upload image</span>
                            </div>
                            <img id="product-image-preview" src=""
                                class="absolute inset-0 w-full h-full object-cover hidden pointer-events-none">
                        </div>
                    </div>
                    <input type="hidden" id="product-image-data">
                </div>

                <!-- Buttons -->
                <div class="flex gap-3 pt-1">
                    <button onclick="closeAddProductModal()"
                        class="flex-1 py-3.5 rounded-xl border-2 border-gray-200 dark:border-gray-700 text-gray-600 dark:text-gray-300 font-bold hover:bg-gray-100 dark:hover:bg-gray-800 transition-all text-sm">Cancel</button>
                    <button onclick="saveProduct()" id="product-modal-btn"
                        class="flex-1 py-3.5 rounded-xl bg-primary hover:bg-emerald-600 text-white font-bold shadow-lg shadow-primary/30 hover:shadow-xl hover:shadow-primary/40 transition-all active:scale-95 text-sm flex items-center justify-center gap-2">
                        <i class="fa-solid fa-floppy-disk"></i>
                        <span>Save Item</span>
                    </button>
                </div>

            </div>
        </div>
    </div>

    <!-- Global Alerts/Notifications -->
    <div id="toast"
        class="fixed top-6 right-6 left-6 md:left-auto bg-gray-900 text-white px-5 py-3.5 rounded-2xl shadow-2xl transform translate-y-[-100px] md:translate-y-0 md:translate-x-40 opacity-0 transition-all duration-300 z-[70] flex items-center gap-3 pointer-events-none cursor-pointer min-w-[260px]"
        onclick="dismissToast()">
        <i class="fa-solid fa-circle-info text-primary text-xl flex-shrink-0" id="toast-icon"></i>
        <div class="flex flex-col flex-1 min-w-0">
            <span class="font-bold text-sm" id="toast-title">Success</span>
            <span id="toast-msg" class="text-xs text-gray-300 truncate">Operation successful</span>
        </div>
        <button onclick="event.stopPropagation(); dismissToast();"
            class="w-6 h-6 rounded-full bg-white/10 hover:bg-white/20 flex items-center justify-center flex-shrink-0 transition-colors ml-1">
            <i class="fa-solid fa-xmark text-xs text-gray-300"></i>
        </button>
    </div>

    <script>
        // --- MOBILE UI LOGIC ---
        function toggleSidebar() {
            const sidebar = document.getElementById('main-sidebar');
            const overlay = document.getElementById('sidebar-overlay');

            if (sidebar.classList.contains('sidebar-mobile-hidden')) {
                sidebar.classList.remove('sidebar-mobile-hidden');
                sidebar.classList.add('sidebar-mobile-visible');
                overlay.classList.remove('hidden');
            } else {
                sidebar.classList.add('sidebar-mobile-hidden');
                sidebar.classList.remove('sidebar-mobile-visible');
                overlay.classList.add('hidden');
            }
        }

        function toggleMobileCart() {
            const cart = document.getElementById('pos-cart-panel');
            const btn = document.getElementById('mobile-cart-btn');

            if (cart.classList.contains('cart-mobile-hidden')) {
                cart.classList.remove('cart-mobile-hidden');
                cart.classList.add('cart-mobile-visible');
                btn.classList.add('hidden'); // Hide button when cart open
            } else {
                cart.classList.add('cart-mobile-hidden');
                cart.classList.remove('cart-mobile-visible');
                btn.classList.remove('hidden'); // Show button
            }
        }

        function updateMobileCartButton() {
            const activeTable = tables.find(t => t.id === activeTableId);
            const count = activeTable ? activeTable.cart.reduce((sum, i) => sum + i.qty, 0) : 0;
            const total = activeTable ? activeTable.cart.reduce((sum, i) => sum + (i.price * i.qty), 0) : 0;

            document.getElementById('mobile-cart-count').innerText = count;
            document.getElementById('mobile-cart-total').innerText = `$${total.toFixed(2)}`;

            const btn = document.getElementById('mobile-cart-btn');
            const cartPanel = document.getElementById('pos-cart-panel');

            // Only show if not empty and cart not open
            if (count > 0 && cartPanel.classList.contains('cart-mobile-hidden')) {
                btn.classList.remove('hidden');
            } else if (count === 0) {
                btn.classList.add('hidden');
            }
        }

        // --- STAFF DATA ---
        let staffList = [
            { id: 1, name: 'Admin User', role: 'Admin', status: 'Active', pin: '1234', avatar: 'Admin' },
            { id: 2, name: 'Floyd Miles', role: 'Manager', status: 'Active', pin: '1234', avatar: 'Floyd+Miles' },
            { id: 3, name: 'Arlene McCoy', role: 'Waiter', status: 'Active', pin: '1234', avatar: 'Arlene+McCoy' },
            { id: 4, name: 'Esther Howard', role: 'Waiter', status: 'Active', pin: '1234', avatar: 'Esther+Howard' },
            { id: 5, name: 'Chef Gordon', role: 'Chef', status: 'Offline', pin: '1234', avatar: 'Chef' },
            { id: 6, name: 'Cash Register', role: 'Cashier', status: 'Active', pin: '1234', avatar: 'Register' }
        ];

        // ==========================================
        // --- I18N: LANGUAGE SYSTEM ---
        // ==========================================
        let currentLang = localStorage.getItem('hudheel_lang') || 'en';

        const TRANSLATIONS = {
            en: {
                // Sidebar
                nav_dashboard: 'Dashboard',
                nav_tables: 'Tables',
                nav_menu: 'Menu',
                nav_kitchen: 'Kitchen',
                nav_orders: 'Orders',
                nav_payments: 'Payments',
                nav_settings: 'Settings',
                nav_logout: 'Logout',
                dark_mode: 'Dark Mode',
                // POS Cart
                current_order: 'Current Order',
                dine_in: 'Dine In',
                sub_total: 'Sub Total',
                tax: 'Tax 5%',
                total_amount: 'Total Amount',
                pay_cash: 'Cash',
                pay_card: 'Card',
                pay_qr: 'QR Code',
                send_to_kitchen: 'Send to Kitchen',
                recall_order: 'Recall Order',
                waiting_chef: 'Waiting for Chef...',
                pay_print: 'Pay & Print',
                view_order: 'View Order',
                total: 'Total',
                search_placeholder: 'Search Product...',
                // Tables View
                tables_title: 'Table Services',
                tables_subtitle: 'Select a table to begin or manage orders.',
                table_status_available: 'Available',
                table_status_occupied: 'Occupied',
                table_status_kitchen: 'Kitchen/Ready',
                table_status_payment: 'Waiting Payment',
                table_btn_select: 'Select Table',
                table_btn_open: 'Open',
                table_empty_cart: 'No items in cart',
                add_table: 'Add Table',
                table_added: 'New table added successfully!',
                prompt_add_tables: 'How many tables would you like to add?',
                toast_invalid_number: 'Please enter a valid number.',
                // Kitchen View
                kitchen_title: 'Kitchen',
                kitchen_sent: 'Sent to Kitchen',
                kitchen_preparing: 'Preparing',
                kitchen_new_badge: 'New Order',
                kitchen_start: 'Start Preparing',
                kitchen_mark_ready: 'Mark Ready',
                kitchen_all_done: 'All orders completed',
                // Admin Dashboard
                admin_title: 'Admin Dashboard',
                admin_subtitle: "Today's performance at a glance",
                admin_live: 'Live Overview',
                admin_refresh: 'Refresh',
                admin_revenue: 'Total Revenue',
                admin_orders: 'Total Orders',
                admin_avg: 'Avg Order Value',
                admin_staff: 'Active Staff',
                admin_chart_title: 'Revenue Analytics',
                admin_chart_sub: 'Last 7 days',
                admin_days7: '7 Days',
                admin_top_waiters: 'Top Waiters',
                admin_top_rank: "Today's Rankings",
                admin_team: 'Team Management',
                admin_team_sub: 'Manage your staff roster',
                admin_add_staff: 'Add Staff',
                admin_no_waiters: 'No orders yet today.',
                admin_no_staff: 'No staff found.',
                // Orders View
                orders_title: 'Orders Registry',
                orders_subtitle: 'Track and manage all completed transactions.',
                orders_col_details: 'Order Details',
                orders_col_assigned: 'Assigned To',
                orders_col_summary: 'Order Summary',
                orders_col_amount: 'Amount Paid',
                orders_col_time: 'Timestamp',
                orders_col_print: 'Print',
                orders_paid: 'Paid',
                orders_empty: 'No completed orders yet today.',
                orders_items: 'Items',
                orders_live_sync: 'Live Sync',
                // Receipt Modal
                receipt_cancel: 'Cancel',
                receipt_pay_print: 'Pay & Print',
                receipt_close: 'Close',
                receipt_print: 'Print Receipt',
                // Settings
                settings_title: 'Settings',
                settings_appearance: 'Appearance',
                settings_dark_mode: 'Dark Mode',
                settings_dark_sub: 'Switch between light and dark themes',
                settings_lang: 'Language',
                settings_lang_sub: 'Choose your preferred language',
                // Staff Table
                staff_name: 'Name',
                staff_role: 'Role',
                staff_status: 'Status',
                staff_actions: 'Actions',
                // Add Staff Modal
                modal_add_staff: 'Add New Staff',
                modal_edit_staff: 'Edit Staff',
                modal_full_name: 'Full Name',
                modal_role: 'Role',
                modal_pin: 'PIN',
                modal_status: 'Status',
                modal_cancel: 'Cancel',
                modal_save: 'Save Changes',
                modal_add_btn: 'Add Staff Member',
                // Notifications
                notif_order_ready: 'Order Ready',
                notif_mark_read: 'Mark all as read',
                // General
                close: 'Close',
                cancel: 'Cancel',
                save: 'Save',
                edit: 'Edit',
                active: 'Active',
                inactive: 'Anactive',
                // Roles
                role_admin: 'Admin',
                role_manager: 'Manager',
                role_waiter: 'Waiter',
                role_chef: 'Chef',
                role_cashier: 'Cashier',
                today: 'Today',
                avg: 'Avg',
                orders_badge: 'Orders',
                live_badge: 'Live',
                // Toast Messages
                toast_select_table: 'Please select a table first',
                toast_recalled: 'Order recalled to Draft status.',
                toast_kitchen_waiting: 'Order is waiting in the kitchen queue.',
                toast_sent_kitchen: 'Order sent to kitchen!',
                toast_paid: 'Payment successful!',
                toast_table_occupied: 'Table is already occupied.',
                toast_staff_added: 'Staff member added.',
                toast_staff_updated: 'Staff member updated.',
                toast_staff_deleted: 'Staff member deleted.',
                toast_order_ready: 'Order is Ready to Serve!',
                toast_add_items: 'Please add items to the cart first.',
                toast_fill_fields: 'Please fill in all required fields.',
                // Release Modal
                release_title: 'Release Table',
                release_confirm_msg: 'Are you sure you want to release this table?',
                release_confirm_sub: 'Unsaved items will be lost.',
                release_keep: 'Keep Table',
                release_yes: 'Yes, Release',
                // Table Status Labels (used on table cards)
                status_available: 'Available',
                status_occupied: 'Occupied',
                status_sending: 'Sending...',
                status_sent: 'Sent to Kitchen',
                status_preparing: 'Preparing',
                status_ready: 'Ready to Serve',
                status_payment: 'Waiting Payment',
                // Table card buttons
                btn_seat_guest: 'Seat Guest',
                btn_view_order: 'View Order',
                btn_take_payment: 'Take Payment',
            },
            so: {
                // Sidebar
                nav_dashboard: 'Bogga Maamulka',
                nav_tables: 'Miisaska',
                nav_menu: 'Cuntooyinka',
                nav_kitchen: 'Jiko',
                nav_orders: 'Dalabka',
                nav_payments: 'Lacag Bixinta',
                nav_settings: 'Goobaha',
                nav_logout: 'Ka Bax',
                dark_mode: 'Muuqaalka Madow',
                // POS Cart
                current_order: 'Dalabka Hadda',
                dine_in: 'Gudaha Cun',
                sub_total: 'Wadarta Hoose',
                tax: 'Canshuurta 5%',
                total_amount: 'Wadarta Guud',
                pay_cash: 'Lacag Cad',
                pay_card: 'Kaarka',
                pay_qr: 'Koodhka QR',
                send_to_kitchen: 'U Dir Jikada',
                recall_order: 'Dib u Soo Qaad',
                waiting_chef: 'Sugaya Kariyaha...',
                pay_print: 'Bixi & Daabac',
                view_order: 'Fiiri Dalabka',
                total: 'Wadarta',
                search_placeholder: 'Raadi Alaab...',
                // Tables View
                tables_title: "Adeegga Miisaska",
                tables_subtitle: 'Dooro miis si aad u bilawdo ama u maamusho dalabyada.',
                table_status_available: 'Banaan',
                table_status_occupied: 'Waa La Qaatay',
                table_status_kitchen: 'Jiko/Diyaar',
                table_status_payment: 'Sugaya Lacag Bixinta',
                table_btn_select: 'Dooro Miiska',
                table_btn_open: 'Fur',
                table_empty_cart: 'Baarkiilka waa faaruq',
                add_table: 'Kudar Miis',
                table_added: 'Miis cusub si guul leh ayaa loogu daray!',
                prompt_add_tables: 'Immiso miisas ayaad jeclaan lahayd inaad ku dartid?',
                toast_invalid_number: 'Fadlan geli lambar sax ah.',
                // Kitchen View
                kitchen_title: 'Jikada',
                kitchen_sent: 'Loo Diray Jikada',
                kitchen_preparing: 'Diyaarinta',
                kitchen_new_badge: 'Dalab Cusub',
                kitchen_start: 'Bilow Diyaarinta',
                kitchen_mark_ready: 'Diyaar',
                kitchen_all_done: 'Dhammaan dalabyadu way dhammaadeen',
                // Admin Dashboard
                admin_title: 'Bogga Maamulka',
                admin_subtitle: 'Guudmar maanta ah',
                admin_live: 'Toos ah',
                admin_refresh: 'Cusboonaysii',
                admin_revenue: 'Dakhliga Guud',
                admin_orders: 'Dalabka Guud',
                admin_avg: 'Celceliska Dalabka',
                admin_staff: 'Shaqaalaha Firfircoon',
                admin_chart_title: 'Dakhliga Bilaha ah',
                admin_chart_sub: '7 Maalmood ee la soo Dhaafay',
                admin_days7: '7 Maalmood',
                admin_top_waiters: 'Kababyada Ugu Fiican',
                admin_top_rank: 'Liiska Maanta',
                admin_team: 'Maamulka Kooxda',
                admin_team_sub: 'Shaqaalahaaga maamul',
                admin_add_staff: 'Kudar Shaqaale',
                admin_no_waiters: 'Wali dalab maanta ma jiro.',
                admin_no_staff: 'Shaqaale lama helin.',
                // Orders View
                orders_title: 'Diiwaanka Dalabka',
                orders_subtitle: 'La socdo oo maamul dhammaan macaamiladii dhammaaday.',
                orders_col_details: 'Faahfaahinta Dalabka',
                orders_col_assigned: 'Loo Xilsaaray',
                orders_col_summary: 'Koobaynta Dalabka',
                orders_col_amount: 'Lacagta La Bixiyay',
                orders_col_time: 'Wakhtiga',
                orders_col_print: 'Daabac',
                orders_paid: 'La Bixiyay',
                orders_empty: 'Wali dalabyo dhammaaday maanta ma jiraan.',
                orders_items: 'Badeecooyin',
                orders_live_sync: 'Toos ah Isku xidhka',
                // Receipt Modal
                receipt_cancel: 'Jooji',
                receipt_pay_print: 'Bixi & Daabac',
                receipt_close: 'Xir',
                receipt_print: 'Daabac Rasiidhka',
                // Settings
                settings_title: 'Goobaha',
                settings_appearance: 'Muuqaalka',
                settings_dark_mode: 'Muuqaalka Madow',
                settings_dark_sub: 'Beddel muuqaalka ifka ama madowga',
                settings_lang: 'Luqadda',
                settings_lang_sub: 'Dooro luqadda aad doorbideyso',
                // Staff Table
                staff_name: 'Magaca',
                staff_role: 'Doorka',
                staff_status: 'Xaaladda',
                staff_actions: 'Ficilada',
                // Add Staff Modal
                modal_add_staff: 'Kudar Shaqaale Cusub',
                modal_edit_staff: 'Beddel Shaqaalaha',
                modal_full_name: 'Magaca Buuxa',
                modal_role: 'Doorka',
                modal_pin: 'Lambarka Sirta',
                modal_status: 'Xaaladda',
                modal_cancel: 'Jooji',
                modal_save: 'Keydi Isbedelada',
                modal_add_btn: 'Kudar Xubin Shaqo',
                // Notifications
                notif_order_ready: 'Dalabku Waa Diyaar',
                notif_mark_read: 'Dhammaan Calaamadi in la aqriyay',
                // General
                close: 'Xir',
                cancel: 'Jooji',
                save: 'Keydi',
                edit: 'Baddel',
                delete: 'Tirtir',
                active: 'Shaqeynaya',
                inactive: 'Ma Shaqeeynayo',
                // Roles
                role_admin: 'Maamule-Guud',
                role_manager: 'Maamule',
                role_waiter: 'Mudalab',
                role_chef: 'Kariye',
                role_cashier: 'Qasnaji',
                today: 'Maanta',
                avg: 'Cels',
                orders_badge: 'Dalabyo',
                live_badge: 'Toos ah',
                // Toast Messages
                toast_select_table: 'Fadlan dooro miis marka hore',
                toast_recalled: 'Dalabkii dib baa loo celiyay.',
                toast_kitchen_waiting: 'Dalabku wuxuu ku jiraa safka jikada.',
                toast_sent_kitchen: 'Dalabka jikada ayaa loo diray!',
                toast_paid: 'Lacag bixinta waa guuleysatay!',
                toast_table_occupied: 'Miiskaan horay baa loo qabtay.',
                toast_staff_added: 'Shaqaalaha waa lagu daray.',
                toast_staff_updated: 'Shaqaalaha waa la cusbooneysiiyay.',
                toast_staff_deleted: 'Shaqaalaha waa la tirtiray.',
                toast_order_ready: 'Dalabku waa diyaar in la adeego!',
                toast_add_items: 'Fadlan alaab ku dar baarkiilka marka hore.',
                toast_fill_fields: 'Fadlan buuxi dhammaan meelaha loo baahan yahay.',
                // Release Modal
                release_title: 'Xir Miiska',
                release_confirm_msg: 'Ma hubtaa inaad rabto inaad xirto miiskan?',
                release_confirm_sub: 'Dalabkani Hawada Ayuu Kabaxayaa .',
                release_keep: 'Sii Hay Miiska',
                release_yes: 'Haa, Xir',
                // Table card buttons Labels
                status_available: 'Banaan',
                status_occupied: 'La Qabtay',
                status_sending: 'Waa la dirayaa...',
                status_sent: 'Loo Diray Jikada',
                status_preparing: 'Diyaarinta',
                status_ready: 'Diyaar',
                status_payment: 'Sugaya Lacag Bixinta',
                // Table card buttons
                btn_seat_guest: 'Fadhiisi Martida',
                btn_view_order: 'Fiiri Dalabka',
                btn_take_payment: 'Qaado Lacagta',
            }
        };

        function t(key) {
            return (TRANSLATIONS[currentLang] && TRANSLATIONS[currentLang][key]) || TRANSLATIONS['en'][key] || key;
        }

        function setLanguage(lang) {
            currentLang = lang;
            localStorage.setItem('hudheel_lang', lang);
            applyLanguage();
        }

        function applyLanguage() {
            // Update all elements with data-i18n attribute
            document.querySelectorAll('[data-i18n]').forEach(el => {
                const key = el.getAttribute('data-i18n');
                el.innerText = t(key);
            });
            // Update placeholder attributes
            document.querySelectorAll('[data-i18n-placeholder]').forEach(el => {
                el.placeholder = t(el.getAttribute('data-i18n-placeholder'));
            });
            // Update language toggle button styles
            const enBtn = document.getElementById('lang-btn-en');
            const soBtn = document.getElementById('lang-btn-so');
            const setEnBtn = document.getElementById('lang-btn-settings-en');
            const setSoBtn = document.getElementById('lang-btn-settings-so');

            if (enBtn && soBtn) {
                if (currentLang === 'en') {
                    enBtn.className = 'flex-1 py-1.5 text-xs font-extrabold rounded-lg bg-primary text-white transition-all shadow-sm';
                    soBtn.className = 'flex-1 py-1.5 text-xs font-extrabold rounded-lg text-gray-400 dark:text-gray-400 hover:text-gray-700 transition-all';
                } else {
                    soBtn.className = 'flex-1 py-1.5 text-xs font-extrabold rounded-lg bg-primary text-white transition-all shadow-sm';
                    enBtn.className = 'flex-1 py-1.5 text-xs font-extrabold rounded-lg text-gray-400 dark:text-gray-400 hover:text-gray-700 transition-all';
                }
            }

            if (setEnBtn && setSoBtn) {
                if (currentLang === 'en') {
                    setEnBtn.className = 'flex-1 rounded-2xl text-white font-bold text-xl transition-all bg-primary shadow-md tracking-wide';
                    setSoBtn.className = 'flex-1 rounded-2xl text-gray-500 dark:text-gray-300 font-bold text-xl hover:text-gray-800 dark:hover:text-white transition-all tracking-wide';
                } else {
                    setSoBtn.className = 'flex-1 rounded-2xl text-white font-bold text-xl transition-all bg-primary shadow-md tracking-wide';
                    setEnBtn.className = 'flex-1 rounded-2xl text-gray-500 dark:text-gray-300 font-bold text-xl hover:text-gray-800 dark:hover:text-white transition-all tracking-wide';
                }
            }
            // Re-render dynamic views if they are currently visible
            if (typeof setupNav === 'function' && window._navSetupDone) setupNav();
            if (typeof renderOrderHistory === 'function') renderOrderHistory();
            if (typeof renderAdmin === 'function' && !document.getElementById('view-admin').classList.contains('hidden')) renderAdmin();
            if (typeof renderKitchen === 'function' && !document.getElementById('view-kitchen').classList.contains('hidden')) renderKitchen();
            if (typeof renderTablesView === 'function') renderTablesView();
            // Always re-render staff table so Active/Inactive labels update on language change
            if (typeof renderStaffTable === 'function' && document.getElementById('staff-table-body')) renderStaffTable();
        }

        const STATUS = {
            AVAILABLE: 'Available',
            OCCUPIED: 'Occupied', // Draft state
            SENT_WAITING_RECALL: 'Sending...', // Waiter 30s grace period
            SENT: 'Sent to Kitchen',
            PREPARING: 'Preparing',
            READY: 'Ready to Serve',
            SERVED: 'Served',
            WAITING_PAYMENT: 'Waiting for Payment'
        };

        // --- TABLE DATA (Upgraded) ---
        let activeTableId = null; // Changed from 'T4' so Waiters must select a table first
        const tables = [
            { id: 'T1', name: 'Available', status: STATUS.AVAILABLE, bg: 'bg-gray-100', text: 'text-gray-400', cart: [], lockedBy: null, waiterName: null, openedAt: null, timestamps: {}, recallTimer: null, recallRemaining: 0, payRecords: [] },
            { id: 'T2', name: 'Available', status: STATUS.AVAILABLE, bg: 'bg-gray-100', text: 'text-gray-400', cart: [], lockedBy: null, waiterName: null, openedAt: null, timestamps: {}, recallTimer: null, recallRemaining: 0, payRecords: [] },
            { id: 'T3', name: 'Available', status: STATUS.AVAILABLE, bg: 'bg-gray-100', text: 'text-gray-400', cart: [], lockedBy: null, waiterName: null, openedAt: null, timestamps: {}, recallTimer: null, recallRemaining: 0, payRecords: [] },
            { id: 'T4', name: 'Available', status: STATUS.AVAILABLE, bg: 'bg-gray-100', text: 'text-gray-400', cart: [], lockedBy: null, waiterName: null, openedAt: null, timestamps: {}, recallTimer: null, recallRemaining: 0, payRecords: [] },
            { id: 'T5', name: 'Available', status: STATUS.AVAILABLE, bg: 'bg-gray-100', text: 'text-gray-400', cart: [], lockedBy: null, waiterName: null, openedAt: null, timestamps: {}, recallTimer: null, recallRemaining: 0, payRecords: [] },
            { id: 'T6', name: 'Available', status: STATUS.AVAILABLE, bg: 'bg-gray-100', text: 'text-gray-400', cart: [], lockedBy: null, waiterName: null, openedAt: null, timestamps: {}, recallTimer: null, recallRemaining: 0, payRecords: [] }
        ];

        let activeCategory = 'all';
        let currentOrderId = 2034;
        let selectedPayment = 'Cash';

        // --- DATA ---
        const categories = [
            { id: 'all', name: 'All', count: 235, icon: 'fa-table-cells-large' },
            { id: 'breakfast', name: 'Breakfast', count: 19, icon: 'fa-egg' },
            { id: 'soups', name: 'Soups', count: 6, icon: 'fa-mug-hot' },
            { id: 'pasta', name: 'Pasta', count: 14, icon: 'fa-utensils' },
            { id: 'main', name: 'Main Course', count: 67, icon: 'fa-bowl-food' },
            { id: 'burger', name: 'Burgers', count: 13, icon: 'fa-burger' },
        ];

        let products = [
            { id: 1, name: "Original Chess Meat Burger With Chips", price: 23.99, category: 'burger', image: "https://images.unsplash.com/photo-1568901346375-23c9450c58cd?q=80&w=400" },
            { id: 2, name: "Fresh Orange Juice With Basil Seed", price: 12.99, category: 'breakfast', image: "https://images.unsplash.com/photo-1613478223719-2ab802602423?q=80&w=400" },
            { id: 3, name: "Meat Sushi Maki With Tuna", price: 9.99, category: 'main', image: "https://images.unsplash.com/photo-1579871494447-9811cf80d66c?q=80&w=400" },
            { id: 4, name: "Tacos Salsa With Chickens Grilled", price: 14.99, category: 'main', image: "https://images.unsplash.com/photo-1565299585323-38d6b0865b47?q=80&w=400" },
            { id: 5, name: "Tasty Vegetable Salad Healthy", price: 17.99, category: 'soups', image: "https://images.unsplash.com/photo-1512621776951-a57141f2eefd?q=80&w=400" },
            { id: 6, name: "Original Chess Burger With French Fries", price: 10.59, category: 'burger', image: "https://images.unsplash.com/photo-1551782450-a2132b4ba21d?q=80&w=400" },
        ];

        let kitchenOrders = [];
        let pendingNotifications = []; // For simulating real-time alerts
        let orderHistory = []; // Paid orders history
        let auditLog = [];     // Structural changes (cancels, overrides, etc)

        // --- DATA PERSISTENCE (LocalStorage) ---
        function loadData() {
            const savedTables = localStorage.getItem('pos_tables');
            const savedKitchen = localStorage.getItem('pos_kitchen');
            const savedHistory = localStorage.getItem('pos_history');
            const savedAudit = localStorage.getItem('pos_audit');
            const savedOrderId = localStorage.getItem('pos_order_id');

            if (savedTables) {
                const parsedTables = JSON.parse(savedTables);
                // Map saved state back to tables array, removing old timers
                parsedTables.forEach((pt, i) => {
                    if (tables[i]) {
                        tables[i] = { ...tables[i], ...pt, recallTimer: null };
                        // If it was in RECALL state on reload, just dump it back to OCCUPIED to be safe
                        if (tables[i].status === STATUS.SENT_WAITING_RECALL) {
                            tables[i].status = STATUS.OCCUPIED;
                            tables[i].recallRemaining = 0;
                        }
                    }
                });
            }
            if (savedKitchen) kitchenOrders = JSON.parse(savedKitchen);
            if (savedHistory) orderHistory = JSON.parse(savedHistory);
            if (savedAudit) auditLog = JSON.parse(savedAudit);
            if (savedOrderId) currentOrderId = parseInt(savedOrderId);
        }

        function saveData() {
            // Don't stringify the interval objects
            const tablesToSave = tables.map(t => {
                const { recallTimer, ...rest } = t;
                return rest;
            });
            localStorage.setItem('pos_tables', JSON.stringify(tablesToSave));
            localStorage.setItem('pos_kitchen', JSON.stringify(kitchenOrders));
            localStorage.setItem('pos_history', JSON.stringify(orderHistory));
            localStorage.setItem('pos_audit', JSON.stringify(auditLog));
            localStorage.setItem('pos_order_id', currentOrderId.toString());
        }

        // Wrap state changers to auto-save
        const originalClearInterval = window.clearInterval;

        // Load immediately
        loadData();

        // --- LOGIN FUNCTIONS ---
        function selectLoginRole(role) {
            selectedRole = role;
            document.querySelectorAll('.role-btn').forEach(btn => {
                const isActive = btn.dataset.role === role;
                btn.className = isActive
                    ? 'role-btn p-3 md:p-4 rounded-2xl border bg-primary/5 border-primary flex flex-col items-center gap-2 md:gap-3 transition-all cursor-pointer'
                    : 'role-btn p-3 md:p-4 rounded-2xl border border-gray-100 bg-gray-50 hover:border-primary hover:bg-primary-light/30 transition-all flex flex-col items-center gap-2 md:gap-3 group cursor-pointer';
                const iconDiv = btn.querySelector('div');
                iconDiv.className = isActive
                    ? 'w-8 h-8 md:w-10 md:h-10 rounded-full bg-primary text-white shadow-sm flex items-center justify-center transition-colors text-sm md:text-base'
                    : 'w-8 h-8 md:w-10 md:h-10 rounded-full bg-white shadow-sm flex items-center justify-center text-gray-400 group-hover:text-primary transition-colors text-sm md:text-base';
                btn.querySelector('span').className = isActive
                    ? 'text-xs md:text-sm font-bold text-primary-dark'
                    : 'text-xs md:text-sm font-semibold text-gray-600 group-hover:text-primary-dark';
            });

            const userSelect = document.getElementById('login-user-select');
            const userContainer = document.getElementById('user-selection-container');
            const usersForRole = staffList.filter(u => u.role.toLowerCase() === role.toLowerCase());
            userSelect.innerHTML = usersForRole.map(u => `<option value="${u.id}">${u.name}</option>`).join('');

            if (usersForRole.length > 0) userContainer.classList.remove('hidden');
            else userContainer.classList.add('hidden');
        }

        function handleLogin() {
            const pin = document.getElementById('login-pin').value;
            const userSelect = document.getElementById('login-user-select');

            if (!selectedRole) return alert('Select a role');

            let userToLogin = null;
            const userId = parseInt(userSelect.value);

            if (userId) userToLogin = staffList.find(u => u.id === userId);
            if (!userToLogin) return alert("No user selected.");

            if (userToLogin.pin === pin) {
                currentUser = userToLogin;
                localStorage.setItem('lastLoggedInUserId', currentUser.id);

                document.getElementById('login-screen').classList.add('hidden');
                document.getElementById('app-container').classList.remove('hidden');
                document.getElementById('user-name-display').innerText = currentUser.name;
                document.getElementById('user-role-label').innerText = currentUser.role;
                document.getElementById('user-avatar').src = `https://ui-avatars.com/api/?name=${currentUser.avatar || currentUser.name.replace(' ', '+')}&background=10B981&color=fff`;

                // Admin buttons setup
                if (currentUser.role === 'Admin') document.getElementById('add-product-btn').classList.remove('hidden');
                else document.getElementById('add-product-btn').classList.add('hidden');

                setupNav();
                applyLanguage();
                renderCategories();

                // Workflow Logic: Users land on their respective primary views
                if (window.postLoginRedirect === 'tables') {
                    window.postLoginRedirect = null;
                    switchView('tables');
                } else if (currentUser.role === 'Admin' || currentUser.role === 'Manager') {
                    switchView('admin');
                } else if (currentUser.role === 'Waiter') {
                    switchView('tables');
                } else if (currentUser.role === 'Chef') {
                    switchView('kitchen');
                } else if (currentUser.role === 'Cashier') {
                    switchView('orders');
                } else {
                    switchView('pos'); // Default view for other roles or if no specific role match
                }

                checkPendingNotifications();
                saveData(); // Save state on login
            } else {
                alert('Invalid PIN (Try 1234)');
            }
        }

        function logout() {
            currentUser = null;
            selectedRole = null;
            activeTableId = null; // Clear selected table
            document.getElementById('login-pin').value = '';
            document.getElementById('user-selection-container').classList.add('hidden');

            document.querySelectorAll('.role-btn').forEach(btn => {
                btn.className = 'role-btn p-3 md:p-4 rounded-2xl border border-gray-100 bg-gray-50 hover:border-primary hover:bg-primary-light/30 transition-all flex flex-col items-center gap-2 md:gap-3 group cursor-pointer';
                const iconDiv = btn.querySelector('div');
                iconDiv.className = 'w-8 h-8 md:w-10 md:h-10 rounded-full bg-white shadow-sm flex items-center justify-center text-gray-400 group-hover:text-primary transition-colors text-sm md:text-base';
                btn.querySelector('span').className = 'text-xs md:text-sm font-semibold text-gray-600 group-hover:text-primary-dark';
            });

            document.getElementById('login-screen').classList.remove('hidden');
            document.getElementById('app-container').classList.add('hidden');
            // Close mobile sidebar if open
            document.getElementById('main-sidebar').classList.add('sidebar-mobile-hidden');
            document.getElementById('sidebar-overlay').classList.add('hidden');
        }

        // --- NAVIGATION & UI ---
        function setupNav() {
            const nav = document.getElementById('nav-menu');
            let items = [];
            const role = currentUser.role;

            // New Menu Structure
            if (['Admin', 'Manager'].includes(role)) {
                items.push({ id: 'admin', label: t('nav_dashboard'), icon: 'fa-border-all' });
            }

            if (['Admin', 'Manager', 'Waiter'].includes(role)) {
                items.push({ id: 'tables', label: t('nav_tables'), icon: 'fa-table-cells' });
                items.push({ id: 'pos', label: t('nav_menu'), icon: 'fa-utensils' });
            }

            // Kitchen limited to Chef only per request
            if (['Chef'].includes(role)) {
                items.push({ id: 'kitchen', label: t('nav_kitchen'), icon: 'fa-fire-burner' });
            }

            if (['Admin', 'Manager', 'Cashier'].includes(role)) {
                items.push({ id: 'orders', label: t('nav_orders'), icon: 'fa-clipboard-list' });
            }

            // Handle Settings Button Visibility â€” hidden for all users in sidebar
            const settingsBtn = document.getElementById('settings-btn');
            if (settingsBtn) {
                settingsBtn.classList.add('hidden');
            }

            window._navSetupDone = true;

            nav.innerHTML = items.map(item => `
                <button onclick="switchView('${item.id}')" data-view="${item.id}" class="nav-item w-full flex items-center gap-4 px-4 py-4 rounded-xl text-gray-500 dark:text-gray-300 hover:text-primary dark:hover:text-primary transition-all font-medium group">
                    <div class="w-10 h-10 rounded-xl flex items-center justify-center text-xl transition-colors icon-container">
                        <i class="fa-solid ${item.icon}"></i>
                    </div>
                    <span>${item.label}</span>
                </button>
            `).join('');
        }

        function switchView(viewId) {
            const views = ['pos', 'kitchen', 'admin', 'tables', 'settings', 'reservation', 'receipt', 'orders'];

            // Handling Cart placeholder click to show Cart panel on mobile or focus on desktop
            if (viewId === 'cart') {
                if (window.innerWidth < 1024) toggleMobileCart();
                // Close sidebar on mobile
                const sidebar = document.getElementById('main-sidebar');
                const overlay = document.getElementById('sidebar-overlay');
                sidebar.classList.add('sidebar-mobile-hidden');
                sidebar.classList.remove('sidebar-mobile-visible');
                overlay.classList.add('hidden');
                return;
            }

            // Close mobile sidebar on navigation
            const sidebar = document.getElementById('main-sidebar');
            const overlay = document.getElementById('sidebar-overlay');
            sidebar.classList.add('sidebar-mobile-hidden');
            sidebar.classList.remove('sidebar-mobile-visible');
            overlay.classList.add('hidden');

            // Close mobile cart panel on navigation away from POS
            const cartPanel = document.getElementById('pos-cart-panel');
            if (cartPanel && cartPanel.classList.contains('cart-mobile-visible')) {
                cartPanel.classList.remove('cart-mobile-visible');
                cartPanel.classList.add('cart-mobile-hidden');
            }

            // Waiter routing logic: If no table active, they shouldn't access Menu directly
            if (viewId === 'pos' && (!activeTableId || tables.find(t => t.id === activeTableId)?.status === 'Available')) {
                showToast(t('toast_select_table'), "warning");
                viewId = 'tables';
            }

            if (views.includes(viewId)) {
                views.forEach(v => document.getElementById(`view-${v}`).classList.add('hidden'));
                document.getElementById(`view-${viewId}`).classList.remove('hidden');

                // Show view-specific layouts
                if (viewId === 'admin') {
                    renderAdmin();
                    renderStaffTable();
                }
                if (viewId === 'orders') renderOrderHistory();
                if (viewId === 'kitchen') renderKitchen();
                if (viewId === 'tables') renderTablesView();

                if (viewId === 'pos') {
                    renderMenu();
                    renderCart();
                }

                // Hide mobile cart button if leaving POS
                if (viewId !== 'pos') document.getElementById('mobile-cart-btn').classList.add('hidden');
                else updateMobileCartButton();
            }

            document.querySelectorAll('.nav-item').forEach(btn => {
                const iconDiv = btn.querySelector('.icon-container');
                if (btn.dataset.view === viewId) {
                    btn.classList.add('bg-primary', 'text-white', 'shadow-lg', 'shadow-primary/30');
                    btn.classList.remove('text-gray-500', 'hover:text-primary', 'dark:text-gray-300', 'dark:hover:text-primary');
                    iconDiv.classList.add('bg-white/20', 'text-white');
                    iconDiv.classList.remove('bg-gray-50', 'dark:bg-gray-700', 'group-hover:bg-primary', 'group-hover:text-white');
                } else {
                    btn.classList.remove('bg-primary', 'text-white', 'shadow-lg', 'shadow-primary/30');
                    btn.classList.add('text-gray-500', 'hover:text-primary', 'dark:text-gray-300', 'dark:hover:text-primary');
                    iconDiv.classList.remove('bg-white/20', 'text-white');
                    iconDiv.classList.add('bg-gray-50', 'dark:bg-gray-700', 'group-hover:bg-primary', 'group-hover:text-white');
                }
            });

            // Handle footer buttons active state (Settings)
            if (viewId === 'settings') {
                const settingsBtn = document.getElementById('settings-btn');
                if (settingsBtn) {
                    const iconDiv = settingsBtn.querySelector('.icon-container');
                    settingsBtn.classList.add('bg-primary', 'text-white', 'shadow-lg', 'shadow-primary/30');
                    settingsBtn.classList.remove('text-gray-500', 'hover:text-primary', 'dark:text-gray-300', 'dark:hover:text-primary');
                    iconDiv.classList.add('bg-white/20', 'text-white');
                }
            } else {
                const settingsBtn = document.getElementById('settings-btn');
                if (settingsBtn) {
                    const iconDiv = settingsBtn.querySelector('.icon-container');
                    settingsBtn.classList.remove('bg-primary', 'text-white', 'shadow-lg', 'shadow-primary/30');
                    settingsBtn.classList.add('text-gray-500', 'hover:text-primary', 'dark:text-gray-300', 'dark:hover:text-primary');
                    iconDiv.classList.remove('bg-white/20', 'text-white');
                }
            }
        }

        // --- DASHBOARD LOGIC (ADMIN CONTENT) ---
        let adminChart = null;

        function renderAdmin() {
            // 1. Calculate Today's Metrics
            const today = new Date().toLocaleDateString();
            const todaysOrders = orderHistory.filter(o => new Date(o.timestamps.paid).toLocaleDateString() === today);

            // Update date display pill
            const dateEl = document.getElementById('admin-date-display');
            if (dateEl) dateEl.innerText = new Date().toLocaleDateString([], { weekday: 'short', month: 'long', day: 'numeric' });


            const totalRevenue = todaysOrders.reduce((sum, o) => sum + o.total, 0);
            const orderCount = todaysOrders.length;
            const avgOrder = orderCount > 0 ? totalRevenue / orderCount : 0;
            const activeStaff = staffList.filter(s => s.status === 'Active').length;

            // 2. Update DOM Metric Cards
            document.getElementById('admin-revenue').innerText = `$${totalRevenue.toFixed(2)}`;
            document.getElementById('admin-orders').innerText = orderCount;
            document.getElementById('admin-avg-order').innerText = `$${avgOrder.toFixed(2)}`;
            document.getElementById('active-staff-count').innerText = activeStaff;

            // 3. Render Chart.js
            const ctx = document.getElementById('salesChart');
            if (!ctx) return;

            // Generate last 7 days labels
            const labels = [];
            const dataPoints = [];

            for (let i = 6; i >= 0; i--) {
                const d = new Date();
                d.setDate(d.getDate() - i);
                labels.push(d.toLocaleDateString([], { weekday: 'short', day: 'numeric' }));

                // If it's today, use real revenue, otherwise generate visual dummy data for the mockup
                if (i === 0) {
                    dataPoints.push(totalRevenue);
                } else {
                    // Dummy data between $300 and $1200 for presentation
                    dataPoints.push(Math.floor(Math.random() * 900) + 300);
                }
            }

            if (adminChart) {
                adminChart.destroy();
            }

            Chart.defaults.font.family = '"Plus Jakarta Sans", sans-serif';
            Chart.defaults.color = '#9CA3AF'; // text-gray-400

            adminChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Daily Revenue ($)',
                        data: dataPoints,
                        backgroundColor: '#10B981',
                        borderRadius: 8,
                        borderSkipped: false,
                        barThickness: 'flex',
                        maxBarThickness: 40
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            backgroundColor: '#1F2937',
                            padding: 12,
                            titleFont: { size: 14, weight: 'bold' },
                            bodyFont: { size: 14 },
                            callbacks: {
                                label: function (context) {
                                    return ' $' + context.raw.toFixed(2);
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            grid: {
                                color: 'rgba(156, 163, 175, 0.1)',
                                drawBorder: false
                            },
                            ticks: {
                                callback: function (value) { return '$' + value; }
                            }
                        },
                        x: {
                            grid: { display: false },
                            ticks: { maxRotation: 0, minRotation: 0 }
                        }
                    }
                }
            });

            // 4. Compute Top Waiters
            const waiterStats = {};
            todaysOrders.forEach(o => {
                const wName = o.waiter || 'Unknown Waiter';
                if (!waiterStats[wName]) waiterStats[wName] = 0;
                waiterStats[wName]++;
            });

            // Sort waiters by highest volume
            const sortedWaiters = Object.entries(waiterStats)
                .map(([name, count]) => ({ name, count }))
                .sort((a, b) => b.count - a.count)
                .slice(0, 3); // Top 3

            const topWaitersList = document.getElementById('top-waiters-list');
            if (topWaitersList) {
                if (sortedWaiters.length === 0) {
                    topWaitersList.innerHTML = `<li class="flex items-center justify-center h-full text-gray-400 text-sm font-medium">No orders yet today</li>`;
                } else {
                    topWaitersList.innerHTML = sortedWaiters.map((w, index) => {
                        const rankColors = ['text-yellow-500', 'text-gray-400', 'text-amber-700'];
                        const badgeBg = ['bg-yellow-50 dark:bg-yellow-900/20', 'bg-gray-50 dark:bg-gray-800', 'bg-amber-50 dark:bg-amber-900/20'];
                        const rankStyle = index < 3 ? rankColors[index] : 'text-gray-400';
                        const bgStyle = index < 3 ? badgeBg[index] : '';
                        const avatarSafe = w.name.replace(' ', '+');

                        return `
                 <li class="flex items-center p-3 rounded-2xl border border-gray-100 dark:border-gray-600/50 bg-white dark:bg-gray-800/50 hover:bg-surface dark:hover:bg-gray-700 transition-colors">
                    <div class="w-8 h-8 rounded-full font-bold flex items-center justify-center mr-3 ${bgStyle} ${rankStyle}">
                       #${index + 1}
                    </div>
                    <img src="https://ui-avatars.com/api/?name=${avatarSafe}&background=random&color=fff" class="w-10 h-10 rounded-full shadow-sm mr-3">
                    <div class="flex-1">
                       <p class="font-bold text-sm text-gray-800 dark:text-white leading-tight">${w.name}</p>
                    </div>
                    <div class="text-right">
                       <p class="font-black text-lg text-primary">${w.count}</p>
                       <p class="text-[10px] text-gray-500 font-bold uppercase tracking-wider">Orders</p>
                    </div>
                 </li>
               `;
                    }).join('');
                }
            }
        }

        // --- DARK MODE LOGIC ---
        function toggleDarkMode() {
            const isDark = document.documentElement.classList.toggle('dark');
            localStorage.setItem('hudheele_dark_mode', isDark ? '1' : '0');

            const icon = document.getElementById('dark-mode-icon');
            if (icon) icon.className = isDark
                ? 'fa-solid fa-sun text-xs text-amber-400'
                : 'fa-solid fa-moon text-xs text-gray-500';
        }

        // Restore saved dark mode preference
        (function () {
            const saved = localStorage.getItem('hudheele_dark_mode');
            if (saved === '1') {
                document.documentElement.classList.add('dark');
                document.addEventListener('DOMContentLoaded', () => {
                    const icon = document.getElementById('dark-mode-icon');
                    if (icon) icon.className = 'fa-solid fa-sun text-xs text-amber-400';
                });
            }
        })();

        // --- STAFF MANAGEMENT ---
        function renderStaffTable() {
            // ... [Preserved exactly as previous]
            const tbody = document.getElementById('staff-table-body');
            const countEl = document.getElementById('active-staff-count');
            const addBtn = document.getElementById('add-staff-btn');

            if (currentUser.role === 'Admin') addBtn.classList.remove('hidden');
            else addBtn.classList.add('hidden');

            const activeCount = staffList.filter(s => s.status === 'Active').length;
            if (countEl) countEl.innerText = activeCount;

            if (!tbody) return;

            tbody.innerHTML = staffList.map(staff => {
                let badgeColor = 'bg-blue-100 text-blue-600';
                if (staff.role === 'Manager') badgeColor = 'bg-purple-100 text-purple-600';
                if (staff.role === 'Chef') badgeColor = 'bg-orange-100 text-orange-600';
                if (staff.role === 'Admin') badgeColor = 'bg-red-100 text-red-600';

                const canModify = currentUser.role === 'Admin' && staff.role !== 'Admin';

                return `
                <tr class="border-b border-gray-100 dark:border-gray-600 last:border-0 hover:bg-gray-50 dark:hover:bg-gray-700 transition-colors">
                    <td class="px-4 py-3 font-medium text-gray-800 dark:text-white">${staff.name}</td>
                    <td class="px-4 py-3">
                        <span class="px-2 py-1 rounded-lg text-xs font-bold ${badgeColor}">${t('role_' + staff.role.toLowerCase())}</span>
                    </td>
                    <td class="px-4 py-3">
                        <span class="px-2 py-1 rounded-lg text-xs font-bold ${staff.status === 'Active' ? 'bg-green-100 text-green-600' : 'bg-gray-100 text-gray-400'}">
                            ${staff.status === 'Active' ? t('active') : t('inactive')}
                        </span>
                    </td>
                    <td class="px-4 py-3 text-right">
                        ${canModify ? `
                        <div class="flex justify-end gap-2">
                            <button onclick="openAddStaffModal(${staff.id})" class="text-gray-400 hover:text-blue-500 transition-colors w-8 h-8 rounded-full hover:bg-blue-50 dark:hover:bg-blue-900/20 flex items-center justify-center"><i class="fa-solid fa-pen"></i></button>
                            <button onclick="deleteStaff(${staff.id})" class="text-gray-400 hover:text-red-500 transition-colors w-8 h-8 rounded-full hover:bg-red-50 dark:hover:bg-red-900/20 flex items-center justify-center"><i class="fa-solid fa-trash"></i></button>
                        </div>` : ''}
                    </td>
                </tr>
            `}).join('');
        }

        // [Preserved Staff Form Modals Logic...]
        function openAddStaffModal(id = null) {
            editingStaffId = id;
            const modal = document.getElementById('add-staff-modal');
            const content = document.getElementById('add-staff-content');
            const title = document.getElementById('modal-title');
            const btn = document.getElementById('modal-submit-btn');

            const nameInput = document.getElementById('new-staff-name');
            const roleInput = document.getElementById('new-staff-role');
            const pinInput = document.getElementById('new-staff-pin');

            if (id) {
                const staff = staffList.find(s => s.id === id);
                title.innerText = t('modal_edit_staff');
                btn.innerText = t('modal_save');
                nameInput.value = staff.name;
                roleInput.value = staff.role;
                pinInput.value = staff.pin;
            } else {
                title.innerText = t('modal_add_staff');
                btn.innerText = t('modal_add_btn');
                nameInput.value = '';
                roleInput.value = 'Waiter';
                pinInput.value = '1234';
            }

            modal.classList.remove('hidden');
            setTimeout(() => {
                content.classList.remove('scale-95', 'opacity-0');
                content.classList.add('scale-100', 'opacity-100');
            }, 10);
        }

        function closeAddStaffModal() {
            const modal = document.getElementById('add-staff-modal');
            const content = document.getElementById('add-staff-content');
            content.classList.remove('scale-100', 'opacity-100');
            content.classList.add('scale-95', 'opacity-0');
            setTimeout(() => { modal.classList.add('hidden'); editingStaffId = null; }, 300);
        }

        function saveStaff() {
            const name = document.getElementById('new-staff-name').value;
            const role = document.getElementById('new-staff-role').value;
            const pin = document.getElementById('new-staff-pin').value;

            if (!name) return alert('Please enter a name');

            if (editingStaffId) {
                const index = staffList.findIndex(s => s.id === editingStaffId);
                if (index !== -1) {
                    staffList[index].name = name;
                    staffList[index].role = role;
                    staffList[index].pin = pin;
                    staffList[index].avatar = name.replace(' ', '+');
                }
                showToast(`${role} â€” ${t('toast_staff_updated')}`, 'success');
            } else {
                const newStaff = {
                    id: Date.now(),
                    name: name,
                    role: role,
                    status: 'Offline',
                    pin: pin,
                    avatar: name.replace(' ', '+')
                };
                staffList.push(newStaff);
                showToast(`${role} â€” ${t('toast_staff_added')}`, 'success');
            }
            renderStaffTable();
            closeAddStaffModal();
        }

        function deleteStaff(id) {
            if (currentUser.role !== 'Admin') return alert('Only Admins can delete staff.');
            if (confirm('Remove this staff member?')) {
                staffList = staffList.filter(s => s.id !== id);
                renderStaffTable();
            }
        }

        // --- PRODUCT MANAGEMENT ---
        function openAddProductModal(id = null) {
            editingProductId = id;
            const modal = document.getElementById('add-product-modal');
            const content = document.getElementById('add-product-content');
            const title = document.getElementById('product-modal-title');
            const btn = document.getElementById('product-modal-btn');

            const catSelect = document.getElementById('product-category');
            catSelect.innerHTML = categories.filter(c => c.id !== 'all').map(c => `<option value="${c.id}">${c.name}</option>`).join('');

            const nameIn = document.getElementById('product-name');
            const priceIn = document.getElementById('product-price');
            const imgData = document.getElementById('product-image-data');
            const imgFile = document.getElementById('product-image-file');
            const imgPreview = document.getElementById('product-image-preview');
            const imgPlaceholder = document.getElementById('product-image-placeholder');

            if (id) {
                const prod = products.find(p => p.id === id);
                title.innerText = 'Edit Item';
                btn.innerText = 'Update Item';
                nameIn.value = prod.name;
                priceIn.value = prod.price;
                catSelect.value = prod.category;
                imgData.value = prod.image;
                if (prod.image) {
                    imgPreview.src = prod.image;
                    imgPreview.classList.remove('hidden');
                    imgPlaceholder.classList.add('hidden');
                } else {
                    imgPreview.src = '';
                    imgPreview.classList.add('hidden');
                    imgPlaceholder.classList.remove('hidden');
                }
            } else {
                title.innerText = 'Add New Item';
                btn.innerText = 'Save Item';
                nameIn.value = '';
                priceIn.value = '';
                imgData.value = '';
                imgFile.value = '';
                imgPreview.src = '';
                imgPreview.classList.add('hidden');
                imgPlaceholder.classList.remove('hidden');
            }

            modal.classList.remove('hidden');
            setTimeout(() => {
                content.classList.remove('scale-95', 'opacity-0');
                content.classList.add('scale-100', 'opacity-100');
            }, 10);
        }

        function closeAddProductModal() {
            const modal = document.getElementById('add-product-modal');
            const content = document.getElementById('add-product-content');
            content.classList.remove('scale-100', 'opacity-100');
            content.classList.add('scale-95', 'opacity-0');
            setTimeout(() => { modal.classList.add('hidden'); editingProductId = null; }, 300);
        }

        function previewProductImage(input) {
            if (input.files && input.files[0]) {
                const reader = new FileReader();
                reader.onload = function (e) {
                    const imgPreview = document.getElementById('product-image-preview');
                    const imgPlaceholder = document.getElementById('product-image-placeholder');
                    imgPreview.src = e.target.result;
                    imgPreview.classList.remove('hidden');
                    imgPlaceholder.classList.add('hidden');
                    document.getElementById('product-image-data').value = e.target.result;
                }
                reader.readAsDataURL(input.files[0]);
            }
        }

        function saveProduct() {
            // Only Admin and Manager can add/edit items
            if (!currentUser || !['Admin', 'Manager'].includes(currentUser.role)) {
                showToast('Only Admin or Manager can manage menu items.', 'error');
                return;
            }

            const name = document.getElementById('product-name').value.trim();
            const price = parseFloat(document.getElementById('product-price').value);
            const category = document.getElementById('product-category').value;
            const image = document.getElementById('product-image-data').value ||
                'https://images.unsplash.com/photo-1546069901-ba9599a7e63c?q=80&w=400';

            if (!name) {
                showToast('Please enter an item name.', 'error');
                return;
            }
            if (isNaN(price) || price <= 0) {
                showToast('Please enter a valid price.', 'error');
                return;
            }
            if (!category) {
                showToast('Please select a category.', 'error');
                return;
            }

            if (editingProductId) {
                const index = products.findIndex(p => p.id === editingProductId);
                if (index !== -1) {
                    products[index] = { ...products[index], name, price, category, image };
                }
                showToast('Item updated successfully!', 'success');
            } else {
                const newId = products.length > 0 ? Math.max(...products.map(p => p.id)) + 1 : 1;
                products.push({ id: newId, name, price, category, image });
                showToast('Item added successfully!', 'success');
            }

            saveData();
            renderCategories();
            renderMenu();
            closeAddProductModal();
        }

        function deleteProduct(id) {
            if (confirm('Delete this item permanently?')) {
                products = products.filter(p => p.id !== id);
                renderMenu();
                showToast("Item Deleted", "success");
            }
        }

        // --- WORKFLOW: TABLE LOGIC ---
        function canEditOrder(table) {
            return table.status === STATUS.OCCUPIED || ['Admin', 'Manager'].includes(currentUser.role);
        }

        function updateReleaseBtnVisibility(table) {
            const btn = document.getElementById('release-table-btn');
            if (!btn) return;
            const canRelease = table &&
                table.status === STATUS.OCCUPIED &&
                (table.lockedBy === currentUser.id || ['Admin', 'Manager'].includes(currentUser.role));
            if (canRelease) {
                btn.classList.remove('hidden');
                btn.classList.add('flex');
            } else {
                btn.classList.add('hidden');
                btn.classList.remove('flex');
            }
        }

        function getStatusStyles(status) {
            switch (status) {
                case STATUS.AVAILABLE:
                    return { cardBg: 'bg-white dark:bg-gray-800', badgeBg: 'bg-gray-100 dark:bg-gray-700', badgeText: 'text-gray-500 dark:text-gray-400', glow: '', icon: 'text-gray-200 dark:text-gray-700/50' };
                case STATUS.OCCUPIED:
                    return { cardBg: 'bg-gradient-to-br from-blue-500 to-cyan-500', badgeBg: 'bg-white/20', badgeText: 'text-white', glow: 'shadow-[0_10px_30px_rgba(59,130,246,0.4)]', icon: 'text-white/10' };
                case STATUS.SENT:
                case STATUS.PREPARING:
                    return { cardBg: 'bg-gradient-to-br from-purple-500 to-indigo-500', badgeBg: 'bg-white/20', badgeText: 'text-white', glow: 'shadow-[0_10px_30px_rgba(168,85,247,0.4)]', icon: 'text-white/10' };
                case STATUS.READY:
                    return { cardBg: 'bg-gradient-to-br from-green-500 to-emerald-500', badgeBg: 'bg-white/20', badgeText: 'text-white', glow: 'shadow-[0_10px_30px_rgba(16,185,129,0.5)] ring-4 ring-green-500/30 ring-offset-2 dark:ring-offset-gray-900', icon: 'text-white/10' };
                case STATUS.SERVED:
                    return { cardBg: 'bg-gradient-to-br from-orange-400 to-amber-500', badgeBg: 'bg-white/20', badgeText: 'text-white', glow: 'shadow-[0_10px_30px_rgba(245,158,11,0.4)]', icon: 'text-white/10' };
                default:
                    return { cardBg: 'bg-white dark:bg-gray-800', badgeBg: 'bg-gray-100 dark:bg-gray-700', badgeText: 'text-gray-500 dark:text-gray-400', glow: '', icon: 'text-gray-200 dark:text-gray-700/50' };
            }
        }

        function renderTablesView() {
            const grid = document.getElementById('tables-grid');
            const addBtn = document.getElementById('add-table-btn');

            if (addBtn) {
                if (currentUser && ['Admin', 'Manager'].includes(currentUser.role)) {
                    addBtn.classList.remove('hidden');
                } else {
                    addBtn.classList.add('hidden');
                }
            }

            if (!grid) return;

            grid.innerHTML = tables.map(table => {
                const styles = getStatusStyles(table.status);
                const isAvailable = table.status === STATUS.AVAILABLE;
                const isLockedByOther = table.lockedBy && table.lockedBy !== currentUser.id && !['Admin', 'Manager'].includes(currentUser.role);

                const total = table.cart.reduce((sum, i) => sum + (i.price * i.qty), 0);
                const itemCount = table.cart.reduce((sum, i) => sum + i.qty, 0);

                // Show a pulsing dot for statuses that require attention/action
                const needsPulse = [STATUS.OCCUPIED, STATUS.READY].includes(table.status);

                const textColor = isAvailable ? 'text-gray-800 dark:text-white' : 'text-white';
                const subtextColor = isAvailable ? 'text-gray-400 dark:text-gray-400' : 'text-white/80';
                const borderColor = isAvailable ? 'border-gray-200 dark:border-gray-700' : 'border-white/20';
                const dashedBorder = isAvailable ? 'border-gray-200 dark:border-gray-700' : 'border-white/30';
                const pulseColor = isAvailable ? 'bg-current' : 'bg-white';

                const pulseHtml = needsPulse ? `<span class="relative flex h-2 w-2"><span class="animate-ping absolute inline-flex h-full w-full rounded-full ${pulseColor} opacity-75"></span><span class="relative inline-flex rounded-full h-2 w-2 ${pulseColor}"></span></span>` : '';

                return `
                <div onclick="openTable('${table.id}')" class="${styles.cardBg} rounded-[2rem] p-6 border ${borderColor} cursor-pointer transition-all duration-300 group relative overflow-hidden ${styles.glow} hover:-translate-y-2 hover:shadow-2xl ${isLockedByOther ? 'opacity-60 grayscale cursor-not-allowed hover:translate-y-0' : ''}">
                    
                    <!-- Decorative Background Icon -->
                    <i class="fa-solid fa-utensils absolute -bottom-8 -right-8 text-9xl ${styles.icon} group-hover:scale-110 transition-transform duration-700 ease-out -rotate-12 z-0"></i>
                    
                    ${!isAvailable ? '<div class="absolute inset-0 bg-gradient-to-t from-black/20 to-transparent z-0"></div>' : ''}

                    <!-- Top Row: Table Number & Status -->
                    <div class="flex justify-between items-start mb-8 relative z-10">
                        <div class="w-16 h-16 rounded-2xl ${styles.badgeBg} flex items-center justify-center text-2xl font-black ${styles.badgeText} backdrop-blur-md shadow-sm border ${borderColor} group-hover:scale-110 transition-transform duration-300">
                            ${table.id.replace('T', '')}
                        </div>
                        <div class="flex flex-col items-end gap-2">
                            <span class="px-3 py-1.5 rounded-xl text-[10px] font-bold uppercase tracking-widest ${styles.badgeBg} ${styles.badgeText} backdrop-blur-md shadow-sm flex items-center gap-2 border ${borderColor}">
                                ${pulseHtml}
                                ${t('status_' + table.status.toLowerCase().replace(/\s+/g, '_').replace('sent_to_kitchen', 'sent').replace('ready_to_serve', 'ready').replace('waiting_payment', 'payment')) || table.status}
                            </span>
                            ${isLockedByOther ? `<div class="bg-black/40 backdrop-blur-sm px-2.5 py-1 rounded-lg flex items-center gap-1.5 shadow-inner border border-white/10"><i class="fa-solid fa-lock text-white/70 text-xs"></i><span class="text-[10px] font-bold text-white">${table.waiterName?.split(' ')[0]}</span></div>` : ''}
                        </div>
                    </div>
                    
                    <!-- Middle Row: Customer Info -->
                    <div class="mb-6 relative z-10">
                        <h3 class="font-bold text-2xl ${textColor} mb-1 group-hover:tracking-wide transition-all duration-300">${table.name === 'Available' ? t('status_available') : table.name}</h3>
                        <p class="text-sm font-medium ${subtextColor} flex items-center gap-2">
                            <i class="fa-solid fa-bell-concierge opacity-70"></i> ${itemCount} ${t('orders_items')}
                            ${table.waiterName && !isLockedByOther ? `<span class="mx-1 opacity-50">â€¢</span><i class="fa-solid fa-user-tag opacity-70"></i> ${table.waiterName.split(' ')[0]}` : ''}
                        </p>
                    </div>

                    <!-- Bottom Row: Total -->
                    <div class="flex justify-between items-center pt-5 border-t border-dashed ${dashedBorder} relative z-10">
                        <span class="${subtextColor} text-xs font-bold uppercase tracking-wider" data-i18n="total">${t('total')}</span>
                        <span class="font-black text-3xl ${textColor}">$${total.toFixed(2)}</span>
                    </div>
                    
                    <!-- Bottom animated accent bar -->
                    <div class="absolute bottom-0 left-0 w-full h-1.5 ${isAvailable ? 'bg-primary' : 'bg-white/40'} transform origin-left scale-x-0 group-hover:scale-x-100 transition-transform duration-500 ease-out z-20"></div>
                </div>
                `;
            }).join('');
        }

        function openTable(tableId) {
            const table = tables.find(t => t.id === tableId);

            // Admin Reopen Check
            if (table.status === STATUS.AVAILABLE && ['Admin', 'Manager'].includes(currentUser.role)) {
                // Use setTimeout to allow the openTable event to settle if they declined
                setTimeout(() => {
                    if (table.status === STATUS.OCCUPIED && table.cart.length === 0) {
                        promptReopenTable(tableId);
                    }
                }, 50);
            }

            if (table.lockedBy && table.lockedBy !== currentUser.id && !['Admin', 'Manager'].includes(currentUser.role)) {
                showToast(t('toast_table_occupied').replace ? `${t('toast_table_occupied')} (${table.waiterName})` : t('toast_table_occupied'), 'error');
                return;
            }

            if (table.status === STATUS.AVAILABLE) {
                table.status = STATUS.OCCUPIED;
                table.lockedBy = currentUser.id;
                table.waiterName = currentUser.name;
                table.name = currentUser.name;
                table.openedAt = new Date();
                table.timestamps = { opened: new Date() };
                table.bg = 'bg-green-100';
                table.text = 'text-green-600';
            }

            activeTableId = tableId;
            document.getElementById('cart-table-name').innerText = `Table ${table.id.replace('T', '')}`;
            document.getElementById('cart-customer-name').innerText = table.name;
            updateReleaseBtnVisibility(table);

            saveData();
            switchView('pos');
        }

        function addNewTable() {
            // Open the custom modal instead of native prompt()
            const modal = document.getElementById('add-table-modal');
            const content = document.getElementById('add-table-content');
            const input = document.getElementById('add-table-count');
            if (!modal) return;
            input.value = '1';
            modal.classList.remove('hidden');
            requestAnimationFrame(() => {
                content.classList.remove('scale-95', 'opacity-0');
                content.classList.add('scale-100', 'opacity-100');
                input.focus();
                input.select();
            });
        }

        function closeAddTableModal() {
            const modal = document.getElementById('add-table-modal');
            const content = document.getElementById('add-table-content');
            content.classList.remove('scale-100', 'opacity-100');
            content.classList.add('scale-95', 'opacity-0');
            setTimeout(() => modal.classList.add('hidden'), 250);
        }

        function confirmAddTable() {
            const countStr = document.getElementById('add-table-count').value;
            const count = parseInt(countStr);
            if (isNaN(count) || count <= 0) {
                showToast(t('toast_invalid_number') || 'Please enter a valid number.', 'error');
                return;
            }

            closeAddTableModal();

            // Add 'count' number of tables
            let nextId = tables.length > 0 ? Math.max(...tables.map(t => parseInt(t.id.replace('T', '')) || 0)) + 1 : 1;

            for (let i = 0; i < count; i++) {
                tables.push({
                    id: `T${nextId}`,
                    name: 'Available',
                    status: STATUS.AVAILABLE,
                    bg: 'bg-gray-100',
                    text: 'text-gray-400',
                    cart: [],
                    lockedBy: null,
                    waiterName: null,
                    openedAt: null,
                    timestamps: {},
                    recallTimer: null,
                    recallRemaining: 0,
                    payRecords: []
                });
                nextId++;
            }

            saveData();
            renderTablesView();
            showToast(`${t('table_added')} (${count})`, 'success');
        }

        // --- ORDERS LOGIC ---
        function renderOrderHistory() {
            const tbody = document.getElementById('orders-table-body');
            if (!tbody) return;

            if (orderHistory.length === 0) {
                tbody.innerHTML = `<tr><td colspan="5" class="px-4 py-8 text-center text-gray-500">No completed orders yet today.</td></tr>`;
                return;
            }

            // Sort newest first
            const sorted = [...orderHistory].sort((a, b) => new Date(b.timestamps.paid) - new Date(a.timestamps.paid));

            tbody.innerHTML = sorted.map(order => {
                // Create a summary of items (e.g. "2x Burger, 1x Coke ...")
                const itemNames = order.items.map(i => `<span class="font-medium text-gray-700 dark:text-gray-200">${i.qty}x</span> ${i.name}`).join('<span class="mx-1 text-gray-300 dark:text-gray-600">â€¢</span>');

                // Count total unique items
                const totalItems = order.items.reduce((sum, i) => sum + i.qty, 0);

                const datePaid = new Date(order.timestamps.paid).toLocaleDateString([], { month: 'short', day: 'numeric' });
                const timePaid = new Date(order.timestamps.paid).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });

                return `
          <tr class="group bg-white dark:bg-gray-800 hover:shadow-md hover:-translate-y-0.5 transition-all duration-300 rounded-2xl">
            <!-- Order ID & Status -->
            <td class="px-6 py-4 rounded-l-2xl border-y border-l border-transparent group-hover:border-gray-100 dark:group-hover:border-gray-700">
              <div class="flex items-center gap-3">
                <div class="w-10 h-10 rounded-full bg-blue-50 dark:bg-blue-900/30 flex items-center justify-center text-blue-600 dark:text-blue-400 shrink-0">
                  <i class="fa-solid fa-receipt"></i>
                </div>
                <div>
                  <div class="font-bold text-gray-900 dark:text-white text-base">#${order.orderId}</div>
                  <div class="text-xs font-semibold text-green-500 bg-green-50 dark:bg-green-500/10 px-2 py-0.5 rounded-full inline-block mt-1">Paid</div>
                </div>
              </div>
            </td>
            
            <!-- Table & Waiter -->
            <td class="px-6 py-4 border-y border-transparent group-hover:border-gray-100 dark:group-hover:border-gray-700">
              <div class="flex items-center gap-3">
                <div class="w-8 h-8 rounded-full bg-orange-100 dark:bg-orange-900/40 flex items-center justify-center text-orange-600 dark:text-orange-400 font-bold shrink-0 text-xs">
                  ${order.tableId.replace('T', '')}
                </div>
                <div>
                  <div class="font-bold text-gray-800 dark:text-gray-200">${order.tableId}</div>
                  <div class="text-xs text-gray-400 flex items-center gap-1"><i class="fa-solid fa-user-tag text-[10px]"></i> ${order.waiter}</div>
                </div>
              </div>
            </td>

            <!-- Items -->
            <td class="px-6 py-4 border-y border-transparent group-hover:border-gray-100 dark:group-hover:border-gray-700">
              <div class="flex flex-col justify-center">
                <span class="text-xs font-bold text-gray-400 uppercase tracking-wider mb-1">${totalItems} Items</span>
                <div class="text-sm text-gray-500 dark:text-gray-400 max-w-sm truncate" title="${order.items.map(i => `${i.qty}x ${i.name}`).join(', ')}">
                  ${itemNames}
                </div>
              </div>
            </td>

            <!-- Price -->
            <td class="px-6 py-4 border-y border-transparent group-hover:border-gray-100 dark:group-hover:border-gray-700 text-right">
              <span class="inline-flex items-center justify-center px-4 py-2 rounded-xl bg-gray-50 dark:bg-gray-900 font-black text-lg text-gray-900 dark:text-white border border-gray-100 dark:border-gray-700">
                $${order.total.toFixed(2)}
              </span>
            </td>

            <!-- Timestamp -->
            <td class="px-6 py-4 border-y border-transparent group-hover:border-gray-100 dark:group-hover:border-gray-700 text-right">
              <div class="flex flex-col items-end justify-center">
                <span class="font-bold text-gray-700 dark:text-gray-300">${timePaid}</span>
                <span class="text-xs text-gray-400">${datePaid}</span>
              </div>
            </td>

            <!-- Print Button (Admin/Manager/Cashier only) -->
            <td class="px-6 py-4 rounded-r-2xl border-y border-r border-transparent group-hover:border-gray-100 dark:group-hover:border-gray-700 text-right">
              ${['Admin', 'Manager', 'Cashier'].includes(currentUser.role) ? `
                <button onclick="printOrderReceipt(${order.orderId})" title="Print Receipt"
                  class="w-9 h-9 rounded-xl bg-primary/10 text-primary hover:bg-primary hover:text-white transition-all duration-200 flex items-center justify-center ml-auto active:scale-90 shadow-sm">
                  <i class="fa-solid fa-print text-sm"></i>
                </button>
              ` : ''}
            </td>
          </tr>
        `;
            }).join('');
        }

        function printOrderReceipt(orderId) {
            const order = orderHistory.find(o => o.orderId === orderId);
            if (!order) return;

            const paidAt = new Date(order.timestamps.paid);

            document.getElementById('receipt-date').innerText = paidAt.toLocaleDateString([], { weekday: 'short', month: 'short', day: 'numeric', year: 'numeric' });
            document.getElementById('receipt-time').innerText = paidAt.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
            document.getElementById('receipt-order-id').innerText = '#' + order.orderId;
            document.getElementById('receipt-table').innerText = order.tableId;
            document.getElementById('receipt-waiter').innerText = order.waiter;

            const subtotal = order.total / 1.05;
            const tax = order.total - subtotal;
            document.getElementById('receipt-subtotal').innerText = '$' + subtotal.toFixed(2);
            document.getElementById('receipt-tax').innerText = '$' + tax.toFixed(2);
            document.getElementById('receipt-total').innerText = '$' + order.total.toFixed(2);

            document.getElementById('receipt-items').innerHTML = order.items.map(i => `
        <tr>
          <td class="py-1">${i.name}</td>
          <td class="py-1 text-center">${i.qty}</td>
          <td class="py-1 text-right">$${(i.price * i.qty).toFixed(2)}</td>
        </tr>
      `).join('');

            // Swap footer buttons: Close + Reprint (no Pay button)
            const actionsDiv = document.querySelector('#receipt-modal .bg-gray-100 .flex');
            if (actionsDiv) {
                actionsDiv.innerHTML = `
          <button onclick="closeReceiptModal()" class="flex-1 py-3 text-gray-600 font-bold bg-white border border-gray-300 rounded-xl hover:bg-gray-50 transition-colors">Close</button>
          <button onclick="window.print()" class="flex-1 py-3 text-white font-bold bg-primary hover:bg-primary-dark rounded-xl shadow-lg transition-colors flex items-center justify-center gap-2">
            <i class="fa-solid fa-print"></i> Print Receipt
          </button>
        `;
            }

            document.getElementById('receipt-modal').classList.remove('hidden');
        }

        // --- ADMIN TOOLS ---
        function showDailySales() {
            if (!currentUser || !['Admin', 'Manager'].includes(currentUser.role)) return;
            const today = new Date().toDateString();
            const todaysOrders = orderHistory.filter(o => new Date(o.timestamps.paid).toDateString() === today);

            const total = todaysOrders.reduce((sum, o) => sum + o.total, 0);
            const tips = todaysOrders.reduce((sum, o) => {
                const paid = o.payments ? o.payments.reduce((s, p) => s + p.amount, 0) : 0;
                return sum + Math.max(0, paid - o.total);
            }, 0);

            console.log(`=== DAILY SALES SUMMARY (${today}) ===`);
            console.log(`Total Orders Completed: ${todaysOrders.length}`);
            console.log(`Gross Revenue: $${total.toFixed(2)}`);
            console.log(`Total Tips/Overpayment: $${tips.toFixed(2)}`);
            console.log("Details:", todaysOrders);

            alert(`=== DAILY SALES (${today}) ===\nOrders: ${todaysOrders.length}\nRevenue: $${total.toFixed(2)}\nCheck console for details.`);
        }

        // Attach to logo secretly
        document.addEventListener("DOMContentLoaded", () => {
            const logo = document.querySelector('.fa-fire-burner')?.parentElement;
            if (logo) {
                logo.addEventListener('dblclick', showDailySales);
                logo.style.cursor = 'pointer';
            }
        });

        // --- POS LOGIC ---
        function renderCategories() {
            const container = document.getElementById('category-container');
            if (!container) return;
            container.innerHTML = categories.map(cat => `
                <div onclick="setCategory('${cat.id}')" 
                     class="cursor-pointer min-w-[120px] md:min-w-[140px] p-3 md:p-4 rounded-3xl border transition-all flex flex-col items-start gap-3 md:gap-4 ${activeCategory === cat.id ? 'bg-primary/10 border-primary shadow-sm' : 'bg-white dark:bg-gray-800 border-transparent hover:border-gray-200 dark:hover:border-gray-600'}">
                    <div class="w-8 h-8 md:w-10 md:h-10 rounded-full flex items-center justify-center text-base md:text-lg ${activeCategory === cat.id ? 'bg-primary text-white' : 'bg-gray-50 dark:bg-gray-700 text-gray-400'}">
                        <i class="fa-solid ${cat.icon}"></i>
                    </div>
                    <div>
                        <h3 class="font-bold text-sm md:text-base text-gray-800 dark:text-white ${activeCategory === cat.id ? 'text-primary-dark' : ''}">${cat.name}</h3>
                        <p class="text-xs text-gray-400 dark:text-gray-300">${cat.count} items</p>
                    </div>
                </div>
            `).join('');
        }

        function setCategory(id) {
            activeCategory = id;
            renderCategories();
            renderMenu();
        }

        function renderMenu() {
            const container = document.getElementById('menu-container');
            if (!container) return;
            const filtered = products.filter(p => activeCategory === 'all' || p.category === activeCategory);
            const activeTable = tables.find(t => t.id === activeTableId);
            const isAdmin = currentUser && currentUser.role === 'Admin';
            const canModify = activeTable && canEditOrder(activeTable);

            container.innerHTML = filtered.map(item => {
                const inCart = activeTable && activeTable.cart.find(c => c.id === item.id);
                const qty = inCart ? inCart.qty : 0;

                return `
                <div class="bg-white dark:bg-gray-800 p-3 md:p-4 rounded-[1.5rem] md:rounded-[2rem] shadow-sm hover:shadow-md transition-all border ${inCart ? 'border-primary' : 'border-transparent'} flex flex-col items-center text-center relative overflow-hidden group">
                    
                    ${isAdmin ? `
                    <div class="absolute top-4 left-4 flex gap-1 z-10 opacity-100 md:opacity-0 group-hover:opacity-100 transition-opacity">
                        <button onclick="event.stopPropagation(); openAddProductModal(${item.id})" class="w-7 h-7 rounded-full bg-white text-blue-500 shadow-md hover:bg-blue-50 flex items-center justify-center text-xs"><i class="fa-solid fa-pen"></i></button>
                        <button onclick="event.stopPropagation(); deleteProduct(${item.id})" class="w-7 h-7 rounded-full bg-white text-red-500 shadow-md hover:bg-red-50 flex items-center justify-center text-xs"><i class="fa-solid fa-trash"></i></button>
                    </div>
                    ` : ''}

                    <div class="w-24 h-24 md:w-32 md:h-32 rounded-full overflow-hidden mb-3 md:mb-4 shadow-lg group-hover:scale-105 transition-transform duration-500">
                        <img src="${item.image}" class="w-full h-full object-cover">
                    </div>
                    <h3 class="font-bold text-gray-800 dark:text-white text-xs md:text-sm leading-tight mb-1 md:mb-2 h-8 md:h-10 overflow-hidden px-1">${item.name}</h3>
                    <div class="text-primary font-bold mb-3 md:mb-4 text-sm md:text-base">$${item.price.toFixed(2)}</div>
                    ${qty > 0 ? `
                        <div class="flex items-center gap-2 md:gap-4 bg-gray-100 dark:bg-gray-700 rounded-xl px-2 py-1 w-full justify-between">
                            <button onclick="updateQty(${item.id}, -1)" class="w-6 h-6 md:w-8 md:h-8 rounded-full bg-white dark:bg-gray-600 text-gray-600 dark:text-white shadow-sm hover:text-red-500 flex items-center justify-center font-bold text-sm ${!canModify ? 'opacity-50 cursor-not-allowed' : ''}">-</button>
                            <span class="font-bold text-gray-800 dark:text-white w-4 text-sm md:text-base">${qty}</span>
                            <button onclick="updateQty(${item.id}, 1)" class="w-6 h-6 md:w-8 md:h-8 rounded-full bg-primary text-white shadow-sm hover:bg-primary-dark flex items-center justify-center font-bold text-sm ${!canModify ? 'opacity-50 cursor-not-allowed' : ''}">+</button>
                        </div>
                    ` : `
                        <button onclick="addToCart(${item.id})" class="w-full py-2 md:py-3 bg-primary/10 text-primary font-bold rounded-xl hover:bg-primary hover:text-white transition-all text-xs md:text-sm ${!canModify ? 'opacity-50 cursor-not-allowed' : ''}">Add to Dish</button>
                    `}
                </div>
            `}).join('');
        }

        function addToCart(id) {
            const activeTable = tables.find(t => t.id === activeTableId);
            if (!activeTable) return;

            if (!canEditOrder(activeTable)) {
                showToast("Cannot modify an order that has been sent to the kitchen.", "warning");
                return;
            }

            const item = products.find(p => p.id === id);
            activeTable.cart.push({ ...item, qty: 1 });
            renderMenu();
            renderCart();
            updateMobileCartButton();
            saveData();
        }

        function updateQty(id, delta) {
            const activeTable = tables.find(t => t.id === activeTableId);
            if (!canEditOrder(activeTable)) {
                showToast("Cannot modify an order that has been sent to the kitchen.", "warning");
                return;
            }

            const idx = activeTable.cart.findIndex(c => c.id === id);
            if (idx > -1) {
                activeTable.cart[idx].qty += delta;
                if (activeTable.cart[idx].qty <= 0) activeTable.cart.splice(idx, 1);
            }
            renderMenu();
            renderCart();
            updateMobileCartButton();
            saveData();
        }

        function renderCart() {
            const container = document.getElementById('cart-container');
            const emptyMsg = '<div id="empty-cart-msg" class="h-full flex flex-col items-center justify-center text-gray-300 dark:text-gray-500"><i class="fa-solid fa-utensils text-5xl mb-4 opacity-50"></i><p class="font-medium">No items yet</p></div>';
            const activeTable = tables.find(t => t.id === activeTableId);

            const statusBadge = document.getElementById('cart-status-badge');
            if (statusBadge && activeTable) {
                statusBadge.innerText = activeTable.status;
                // Use solid colors for the badge in the white cart sidebar (not transparent overlays)
                const badgeStyles = {
                    [STATUS.AVAILABLE]: 'bg-gray-100 text-gray-500',
                    [STATUS.OCCUPIED]: 'bg-blue-100 text-blue-600',
                    [STATUS.SENT]: 'bg-purple-100 text-purple-700',
                    [STATUS.PREPARING]: 'bg-purple-100 text-purple-700',
                    [STATUS.READY]: 'bg-green-100 text-green-700',
                    [STATUS.SERVED]: 'bg-orange-100 text-orange-600',
                };
                const colorClass = badgeStyles[activeTable.status] || 'bg-gray-100 text-gray-500';
                statusBadge.className = `mt-2 inline-block px-3 py-1.5 rounded-xl text-[10px] font-bold uppercase tracking-widest ${colorClass} shadow-sm`;
            }

            // --- Reset button visibility (runs before early return so it always applies) ---
            updateReleaseBtnVisibility(activeTable);

            if (!activeTable || activeTable.cart.length === 0) {
                container.innerHTML = emptyMsg;
                updateTotals();
                updateMobileCartButton();
                updateMainActionButton();
                return;
            }

            const canModify = canEditOrder(activeTable);

            container.innerHTML = activeTable.cart.map(item => `
                <div class="flex items-center gap-3 animate-fade-in border-b border-gray-50 dark:border-gray-700 pb-2 last:border-0">
                    <img src="${item.image}" class="w-14 h-14 md:w-16 md:h-16 rounded-2xl object-cover bg-gray-100">
                    <div class="flex-1 min-w-0">
                        <h4 class="text-xs md:text-sm font-bold text-gray-800 dark:text-white truncate mb-1">${item.name}</h4>
                        <div class="flex items-center justify-between">
                            <span class="text-primary font-bold text-sm">$${item.price}</span>
                            <div class="flex items-center gap-2">
                                ${canModify ? `<button onclick="updateQty(${item.id}, -1)" class="w-6 h-6 rounded-full bg-gray-100 dark:bg-gray-700 flex items-center justify-center text-xs"><i class="fa-solid fa-minus"></i></button>` : ''}
                                <span class="text-gray-400 dark:text-gray-300 text-xs font-bold">${item.qty} ${!canModify ? 'X' : ''}</span>
                                ${canModify ? `<button onclick="updateQty(${item.id}, 1)" class="w-6 h-6 rounded-full bg-primary text-white flex items-center justify-center text-xs"><i class="fa-solid fa-plus"></i></button>` : ''}
                            </div>
                        </div>
                    </div>
                </div>
            `).join('');

            updateTotals();
            updateMobileCartButton();
            updateMainActionButton();
        }

        function updateTotals() {
            const activeTable = tables.find(t => t.id === activeTableId);
            const sub = activeTable ? activeTable.cart.reduce((sum, i) => sum + (i.price * i.qty), 0) : 0;
            const tax = sub * 0.05;
            document.getElementById('subtotal-display').innerText = `$${sub.toFixed(2)}`;
            document.getElementById('tax-display').innerText = `$${tax.toFixed(2)}`;
            document.getElementById('total-display').innerText = `$${(sub + tax).toFixed(2)}`;
            if (document.getElementById('total-display-mobile')) {
                document.getElementById('total-display-mobile').innerText = `$${(sub + tax).toFixed(2)}`;
            }
        }

        function setPaymentMethod(method) {
            selectedPayment = method;
            document.querySelectorAll('.payment-btn').forEach(btn => {
                btn.className = 'payment-btn flex-1 py-3 px-2 rounded-xl border border-gray-200 dark:border-gray-600 text-gray-400 hover:border-gray-300 flex flex-col items-center justify-center gap-1 transition-all';
            });
            const activeBtn = document.getElementById(`pay-${method.toLowerCase()}`);
            if (activeBtn) activeBtn.className = 'payment-btn flex-1 py-3 px-2 rounded-xl border border-primary bg-primary/5 text-primary flex flex-col items-center justify-center gap-1 transition-all';
        }

        // --- TABLE RELEASE LOGIC ---
        function requestReleaseTable() {
            const activeTable = tables.find(t => t.id === activeTableId);
            if (!activeTable) return;

            // Frontend guard: status check
            if (activeTable.status !== STATUS.OCCUPIED) {
                showToast('Cannot release a table after the order has been sent to the kitchen.', 'error');
                return;
            }

            // Frontend guard: permission check
            const isAuthorized = activeTable.lockedBy === currentUser.id || ['Admin', 'Manager'].includes(currentUser.role);
            if (!isAuthorized) {
                showToast('You do not have permission to release this table.', 'error');
                return;
            }

            openReleaseModal();
        }

        function openReleaseModal() {
            const modal = document.getElementById('release-table-modal');
            const content = document.getElementById('release-modal-content');
            if (!modal || !content) return;
            modal.classList.remove('hidden');
            requestAnimationFrame(() => {
                requestAnimationFrame(() => {
                    content.style.transform = 'scale(1)';
                    content.style.opacity = '1';
                });
            });
        }

        function closeReleaseModal() {
            const modal = document.getElementById('release-table-modal');
            const content = document.getElementById('release-modal-content');
            if (!modal || !content) return;
            content.style.transform = 'scale(0.93)';
            content.style.opacity = '0';
            setTimeout(() => modal.classList.add('hidden'), 200);
        }

        function confirmReleaseTable() {
            const activeTable = tables.find(t => t.id === activeTableId);
            if (!activeTable) { closeReleaseModal(); return; }

            // Backend-equivalent validation (re-validated server-side in memory)
            if (activeTable.status !== STATUS.OCCUPIED) {
                closeReleaseModal();
                showToast('Cannot release a table after the order has been sent to the kitchen.', 'error');
                return;
            }
            const isAuthorized = activeTable.lockedBy === currentUser.id || ['Admin', 'Manager'].includes(currentUser.role);
            if (!isAuthorized) {
                closeReleaseModal();
                showToast('You do not have permission to release this table.', 'error');
                return;
            }

            const assignedUserId = activeTable.lockedBy;

            // Perform the release
            activeTable.cart = [];
            activeTable.status = STATUS.AVAILABLE;
            activeTable.lockedBy = null;
            activeTable.waiterName = null;
            activeTable.name = 'Available';
            activeTable.bg = 'bg-gray-100';
            activeTable.text = 'text-gray-400';
            activeTable.openedAt = null;
            activeTable.timestamps = {};
            activeTable.payRecords = [];

            activeTableId = null;
            renderCart();

            saveData();
            closeReleaseModal();

            if (!currentUser || currentUser.id === assignedUserId) {
                handleTableReleaseRedirect();
            } else {
                setTimeout(() => {
                    renderTables();
                    switchView('tables');
                    showToast('Table released successfully.', 'success');
                }, 220);
            }
        }

        // --- WORKFLOW BUTTON LOGIC ---
        function updateMainActionButton() {
            const activeTable = tables.find(t => t.id === activeTableId);
            const btn = document.getElementById('main-action-btn');
            const pmc = document.getElementById('payment-methods-container');

            if (!activeTable || activeTable.cart.length === 0) {
                btn.innerText = t('send_to_kitchen');
                btn.className = 'w-full bg-gray-300 dark:bg-gray-700 text-gray-500 font-bold py-4 rounded-xl transition-all cursor-not-allowed text-sm uppercase tracking-wide';
                btn.disabled = true;
                pmc.classList.add('hidden');
                return;
            }

            btn.disabled = false;
            btn.className = 'w-full bg-primary hover:bg-primary-dark text-white font-bold py-4 rounded-xl shadow-lg shadow-primary/30 transition-all active:scale-95 text-sm uppercase tracking-wide';

            pmc.classList.add('hidden');

            // Manage Recall Button injection (Removed, handled by main button)
            let recallBtn = document.getElementById('recall-order-btn');
            if (recallBtn) recallBtn.remove();

            switch (activeTable.status) {
                case STATUS.OCCUPIED:
                    btn.innerText = t('send_to_kitchen');
                    break;
                case STATUS.SENT:
                    if (activeTable.recallRemaining > 0) {
                        btn.innerText = `${t('recall_order')} (${activeTable.recallRemaining}s)`;
                        btn.className = 'w-full bg-red-50 text-red-500 hover:bg-red-100 font-bold py-4 rounded-xl shadow-lg transition-all active:scale-95 text-sm uppercase tracking-wide border border-red-200';
                    } else {
                        btn.innerText = t('waiting_chef');
                        btn.className = 'w-full bg-yellow-500 text-white font-bold py-4 rounded-xl shadow-lg transition-all active:scale-95 text-sm uppercase tracking-wide cursor-wait';
                    }
                    break;
                case STATUS.PREPARING:
                    btn.innerText = t('kitchen_preparing') + '...';
                    btn.className = 'w-full bg-yellow-500 text-white font-bold py-4 rounded-xl shadow-lg transition-all active:scale-95 text-sm uppercase tracking-wide cursor-wait';
                    break;
                case STATUS.READY:
                    btn.innerText = t('kitchen_mark_ready');
                    btn.className = 'w-full bg-orange-500 hover:bg-orange-600 text-white font-bold py-4 rounded-xl shadow-lg transition-all active:scale-95 text-sm uppercase tracking-wide';
                    break;
                case STATUS.SERVED:
                    btn.innerText = t('pay_print');
                    btn.className = 'w-full bg-blue-500 hover:bg-blue-600 text-white font-bold py-4 rounded-xl shadow-lg transition-all active:scale-95 text-sm uppercase tracking-wide';
                    pmc.classList.remove('hidden');
                    break;
                default:
                    btn.innerText = t('send_to_kitchen');
            }
        }

        // --- MAIN ACTION LOGIC ---
        function handleMainAction() {
            const activeTable = tables.find(t => t.id === activeTableId);
            if (!activeTable || activeTable.cart.length === 0) return;

            switch (activeTable.status) {
                case STATUS.OCCUPIED:
                    const orderId = currentOrderId++;
                    const newOrder = {
                        id: orderId,
                        tableId: activeTable.id,
                        waiterId: activeTable.lockedBy,
                        waiterName: activeTable.waiterName,
                        time: new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' }),
                        items: JSON.parse(JSON.stringify(activeTable.cart)),
                        status: 'new'
                    };
                    kitchenOrders.unshift(newOrder);

                    activeTable.status = STATUS.SENT;
                    activeTable.timestamps.sent = new Date();

                    // Start 30-Second Recall Timer
                    activeTable.recallRemaining = 30;
                    if (activeTable.recallTimer) clearInterval(activeTable.recallTimer);

                    activeTable.recallTimer = setInterval(() => {
                        const t = tables.find(tbl => tbl.id === activeTable.id);
                        if (!t || t.status !== STATUS.SENT || t.recallRemaining <= 0) {
                            if (t && t.recallTimer) {
                                clearInterval(t.recallTimer);
                                t.recallTimer = null;
                            }
                            updateMainActionButton();
                            return;
                        }
                        t.recallRemaining--;
                        if (t.id === activeTableId) updateMainActionButton();
                    }, 1000);

                    saveData();
                    renderKitchen();
                    updateMainActionButton(); // immediate visual change

                    showToast(`${t('nav_orders')} #${orderId} â€” ${t('toast_sent_kitchen')}`, 'success');
                    break;

                case STATUS.SENT:
                    // If clicked while SENT and there's time remaining, Recall it!
                    if (activeTable.recallRemaining > 0) {
                        kitchenOrders = kitchenOrders.filter(o => o.tableId !== activeTable.id || o.status !== 'new');
                        activeTable.status = STATUS.OCCUPIED;
                        if (activeTable.recallTimer) clearInterval(activeTable.recallTimer);
                        activeTable.recallTimer = null;
                        activeTable.recallRemaining = 0;
                        showToast(t('toast_recalled'), "success");
                        saveData();
                    } else {
                        showToast(t('toast_kitchen_waiting'), "info");
                    }
                    break;

                case STATUS.READY:
                    activeTable.status = STATUS.SERVED;
                    activeTable.timestamps.served = new Date();
                    showToast("Order marked as served.", "success");
                    saveData();
                    break;

                case STATUS.SERVED:
                    const sub = activeTable.cart.reduce((sum, i) => sum + (i.price * i.qty), 0);
                    const tax = sub * 0.05;
                    const totalAmount = sub + tax; // Include tax

                    const alreadyPaid = activeTable.payRecords.reduce((sum, record) => sum + record.amount, 0);
                    const remaining = totalAmount - alreadyPaid;

                    if (remaining <= 0) {
                        showToast("Order already fully paid. Releasing table...", "info");
                        releaseTableAndLog(activeTable, totalAmount);
                        return;
                    }

                    openReceiptModal(activeTable, remaining, totalAmount, sub, tax);
                    break;

                case STATUS.SENT:
                case STATUS.PREPARING:
                    showToast("Order is currently in the kitchen.", "info");
                    break;
            }

            renderMenu();
            renderCart();

            const cartPanel = document.getElementById('pos-cart-panel');
            if (cartPanel && cartPanel.classList.contains('cart-mobile-visible') && activeTable.status !== STATUS.WAITING_PAYMENT) {
                toggleMobileCart();
            }
        }

        // --- RECEIPT MODAL LOGIC ---
        let currentReceiptTable = null;
        let currentReceiptTotal = 0;

        function openReceiptModal(table, remainingAmount, totalAmount, subtotal, taxAmount) {
            currentReceiptTable = table;
            currentReceiptTotal = totalAmount; // The amount we are trying to resolve

            const now = new Date();
            document.getElementById('receipt-date').innerText = now.toLocaleDateString();
            document.getElementById('receipt-time').innerText = now.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });

            document.getElementById('receipt-order-id').innerText = `#${table.cart.length > 0 ? table.cart[0].id : Date.now().toString().slice(-4)}`;
            document.getElementById('receipt-table').innerText = table.id;
            document.getElementById('receipt-waiter').innerText = table.waiterName;

            document.getElementById('receipt-subtotal').innerText = `$${subtotal.toFixed(2)}`;
            document.getElementById('receipt-tax').innerText = `$${taxAmount.toFixed(2)}`;

            // Handle partial payment display if needed
            const alreadyPaid = table.payRecords.reduce((sum, record) => sum + record.amount, 0);
            let totalDisplayHTML = `$${totalAmount.toFixed(2)}`;
            if (alreadyPaid > 0) {
                totalDisplayHTML += `<br><span class="text-xs text-gray-500 font-normal">Paid: $${alreadyPaid.toFixed(2)}</span><br><span class="text-sm">Remaining: $${remainingAmount.toFixed(2)}</span>`;
            }
            document.getElementById('receipt-total').innerHTML = totalDisplayHTML;

            const itemsHtml = table.cart.map(i => `
          <tr>
             <td class="py-1 break-words">${i.name}</td>
             <td class="py-1 text-center whitespace-nowrap">x${i.qty}</td>
             <td class="py-1 text-right whitespace-nowrap">$${(i.price * i.qty).toFixed(2)}</td>
          </tr>
       `).join('');
            document.getElementById('receipt-items').innerHTML = itemsHtml;

            document.getElementById('receipt-modal').classList.remove('hidden');
        }

        function closeReceiptModal() {
            document.getElementById('receipt-modal').classList.add('hidden');
            currentReceiptTable = null;
        }

        function processReceiptPayment() {
            if (!currentReceiptTable) return;
            const table = currentReceiptTable;

            const alreadyPaid = table.payRecords.reduce((sum, record) => sum + record.amount, 0);
            const remaining = currentReceiptTotal - alreadyPaid;

            // Automatically assume exact amount tendered since the manual input field was removed
            table.payRecords.push({
                method: selectedPayment,
                amount: remaining,
                timestamp: new Date().toISOString(),
                user: currentUser.name
            });

            closeReceiptModal();

            table.timestamps.paid = new Date();
            releaseTableAndLog(table, currentReceiptTotal);
        }

        function releaseTableAndLog(table, totalAmount) {
            const assignedUserId = table.lockedBy;

            // 1. Move to history
            orderHistory.push({
                orderId: table.cart.length > 0 ? (table.cart[0].id + Math.floor(Math.random() * 1000)) : Date.now(), // Fallback ID
                tableId: table.id,
                items: JSON.parse(JSON.stringify(table.cart)),
                total: totalAmount,
                payments: JSON.parse(JSON.stringify(table.payRecords)),
                waiter: table.waiterName,
                timestamps: table.timestamps
            });

            console.log("Order History Logged", orderHistory[orderHistory.length - 1]);

            // 2. Clear table
            table.cart = [];
            table.status = STATUS.AVAILABLE;
            table.name = 'Available';
            table.lockedBy = null;
            table.waiterName = null;
            table.payRecords = [];

            showToast(t('toast_paid'), "success");
            saveData();

            if (!currentUser || currentUser.id === assignedUserId) {
                handleTableReleaseRedirect();
            } else {
                switchView('tables');
            }
        }

        function promptReopenTable(tableId) {
            if (!['Admin', 'Manager'].includes(currentUser.role)) return;

            const recentOrderIndex = orderHistory.map(o => o.tableId).lastIndexOf(tableId);
            if (recentOrderIndex === -1) {
                showToast("No recent orders found for this table to reopen.", "warning");
                return;
            }

            const orderToRestore = orderHistory[recentOrderIndex];
            // Check if it was closed within the last 2 hours to prevent crazy restoring
            const closeTime = orderToRestore.timestamps.paid ? new Date(orderToRestore.timestamps.paid).getTime() : 0;
            if (Date.now() - closeTime > (2 * 60 * 60 * 1000)) {
                showToast("Last order is too old to safely reopen (> 2 hours).", "error");
                return;
            }

            if (confirm(`Admin Action: Do you want to reopen the last closed order for ${tableId}? Total was $${orderToRestore.total.toFixed(2)}.`)) {
                const table = tables.find(t => t.id === tableId);

                // Log the structural override
                auditLog.push({
                    action: 'REOPEN_TABLE',
                    table: tableId,
                    user: currentUser.name,
                    reason: 'Overrides paid status',
                    timestamp: new Date().toISOString()
                });

                table.cart = orderToRestore.items;
                table.payRecords = orderToRestore.payments;
                table.status = STATUS.WAITING_PAYMENT; // Put back to payment screen
                table.lockedBy = currentUser.id;
                table.waiterName = currentUser.name;
                table.name = orderToRestore.waiter + " (Reopened)";
                table.timestamps = orderToRestore.timestamps;

                // Remove from history so it doesn't double-count later
                orderHistory.splice(recentOrderIndex, 1);

                showToast(`Table ${tableId} restored to WAITING PAYMENT.`, "success");
                saveData();
                renderTablesView(); // Refresh visual
                openTable(tableId); // Focus it
            }
        }

        // --- KITCHEN LOGIC ---
        function renderKitchen() {
            const grid = document.getElementById('kitchen-grid');
            const empty = document.getElementById('kitchen-empty');
            if (!grid) return;

            if (kitchenOrders.length === 0) {
                grid.innerHTML = '';
                empty.classList.remove('hidden');
                return;
            }
            empty.classList.add('hidden');

            grid.innerHTML = kitchenOrders.map(order => {
                const isNew = order.status === 'new';

                // Match table card color scheme exactly
                // new (SENT) â†’ purple-to-indigo  |  preparing â†’ green-to-emerald
                const cardGradient = isNew
                    ? 'bg-gradient-to-br from-purple-500 to-indigo-500'
                    : 'bg-gradient-to-br from-green-500 to-emerald-500';
                const cardShadow = isNew
                    ? 'shadow-[0_10px_30px_rgba(168,85,247,0.4)] hover:shadow-[0_16px_40px_rgba(168,85,247,0.55)]'
                    : 'shadow-[0_10px_30px_rgba(16,185,129,0.4)] hover:shadow-[0_16px_40px_rgba(16,185,129,0.55)]';

                // Badge â€” white glass pill (same as table status badge)
                const badgeLabel = isNew ? t('kitchen_sent') : t('kitchen_preparing');

                // Glow blob
                const glowColor = isNew ? '#a855f7' : '#10b981';

                // Button â€” white glass style, matches interior of gradient cards
                const btnAction = isNew
                    ? `<i class="fa-solid fa-fire-burner mr-2"></i>${t('kitchen_start')}`
                    : `<i class="fa-solid fa-bell mr-2"></i>${t('kitchen_mark_ready')}`;
                const nextStatus = isNew ? 'preparing' : 'ready';

                return `
          <div class="group ${cardGradient} rounded-3xl overflow-hidden flex flex-col relative transition-all duration-500 hover:-translate-y-2 ${cardShadow} cursor-default">

            <!-- Glow blob -->
            <div class="absolute -top-6 -right-6 w-32 h-32 rounded-full opacity-20 blur-2xl pointer-events-none transition-opacity duration-300 group-hover:opacity-40"
              style="background: radial-gradient(circle, ${glowColor}, transparent 70%);"></div>

            <!-- Header -->
            <div class="p-5 flex justify-between items-start relative z-10">
              <div>
                <div class="flex items-center gap-2 mb-1">
                  <h3 class="font-black text-2xl text-white tracking-tight">${order.tableId}</h3>
                  <span class="text-xs text-white/50 font-bold mt-1">#${order.id}</span>
                </div>
                <div class="flex items-center gap-2 text-xs text-white/70">
                  <i class="fa-regular fa-clock text-[10px]"></i>
                  <span>${order.time}</span>
                  <span class="text-white/30">|</span>
                  <i class="fa-solid fa-user text-[10px]"></i>
                  <span>${order.waiterName.split(' ')[0]}</span>
                </div>
              </div>
              <span class="flex items-center gap-1.5 bg-white/20 border border-white/30 backdrop-blur-sm px-3 py-1.5 rounded-full text-[11px] font-extrabold uppercase tracking-wider text-white shadow-inner">
                <span class="w-1.5 h-1.5 rounded-full bg-white animate-pulse"></span>
                ${badgeLabel}
              </span>
            </div>

            <!-- Divider -->
            <div class="mx-5 border-t border-white/15"></div>

            <!-- Items -->
            <div class="p-5 flex-1 space-y-2.5 relative z-10">
              ${order.items.map(i => `
                <div class="flex justify-between items-center">
                  <span class="text-sm text-white/90 font-semibold">${i.name}</span>
                  <span class="text-xs font-black text-white bg-white/20 border border-white/20 px-2.5 py-1 rounded-xl">Ã—${i.qty}</span>
                </div>
              `).join('')}
            </div>

            <!-- Action Button -->
            <div class="p-4 pt-0 relative z-10">
              <button onclick="updateKitchenStatus(${order.id}, '${nextStatus}')"
                class="w-full py-3.5 rounded-2xl bg-black/20 hover:bg-black/30 border border-white/20 text-white font-black text-sm uppercase tracking-wide transition-all duration-300 hover:shadow-xl active:scale-95 hover:-translate-y-0.5 backdrop-blur-sm">
                ${btnAction}
              </button>
            </div>
          </div>
        `;
            }).join('');


        }

        function updateKitchenStatus(orderId, nextStatus) {
            const kOrder = kitchenOrders.find(o => o.id === orderId);
            if (!kOrder) return;

            kOrder.status = nextStatus;

            const table = tables.find(t => t.id === kOrder.tableId);
            if (table) {
                if (nextStatus === 'preparing') {
                    table.status = STATUS.PREPARING;
                } else if (nextStatus === 'ready') {
                    table.status = STATUS.READY;
                    pendingNotifications.push({
                        targetUserId: kOrder.waiterId,
                        message: `Order for ${kOrder.tableId} is Ready to Serve!`
                    });

                    kitchenOrders = kitchenOrders.filter(o => o.id !== orderId);
                }
            }

            renderKitchen();
            checkPendingNotifications();
            saveData();
        }

        // --- NOTIFICATION SYSTEM ---
        function checkPendingNotifications() {
            if (!currentUser) return;

            const userNotifs = pendingNotifications.filter(n => n.targetUserId === currentUser.id || currentUser.role === 'Admin');

            if (userNotifs.length > 0) {
                userNotifs.forEach((n, idx) => {
                    setTimeout(() => {
                        showToast(n.message, "info");
                    }, idx * 1500);
                });
                pendingNotifications = pendingNotifications.filter(n => n.targetUserId !== currentUser.id && currentUser.role !== 'Admin');
                renderTablesView();
            }
        }

        setInterval(checkPendingNotifications, 3000);

        let _toastTimer = null;

        function showToast(msg, type = 'success') {
            const toast = document.getElementById('toast');
            const icon = document.getElementById('toast-icon');
            const title = document.getElementById('toast-title');

            document.getElementById('toast-msg').innerText = msg;

            if (type === 'success') {
                icon.className = 'fa-solid fa-circle-check text-primary text-xl flex-shrink-0';
                title.innerText = 'Success';
            } else if (type === 'error') {
                icon.className = 'fa-solid fa-circle-exclamation text-red-500 text-xl flex-shrink-0';
                title.innerText = 'Action Denied';
            } else if (type === 'info') {
                icon.className = 'fa-solid fa-bell text-blue-500 text-xl flex-shrink-0';
                title.innerText = 'Notification';
            } else if (type === 'warning') {
                icon.className = 'fa-solid fa-triangle-exclamation text-orange-500 text-xl flex-shrink-0';
                title.innerText = 'Warning';
            }

            // Cancel any existing timer then show
            if (_toastTimer) clearTimeout(_toastTimer);
            toast.classList.remove('translate-y-[-100px]', 'md:translate-x-40', 'opacity-0', 'pointer-events-none');
            toast.classList.add('pointer-events-auto');
            _toastTimer = setTimeout(() => dismissToast(), 4000);
        }

        function dismissToast() {
            const toast = document.getElementById('toast');
            if (_toastTimer) { clearTimeout(_toastTimer); _toastTimer = null; }
            toast.classList.add('translate-y-[-100px]', 'md:translate-x-40', 'opacity-0', 'pointer-events-none');
            toast.classList.remove('pointer-events-auto');
        }

        // --- TABLE RELEASE REDIRECT LOGIC ---
        function handleTableReleaseRedirect(forceLogin = false) {
            if (!currentUser || forceLogin) {
                window.postLoginRedirect = 'tables';
                document.getElementById('login-screen').classList.remove('hidden');
                document.getElementById('app-container').classList.add('hidden');
                activeTableId = null;
            } else {
                switchView('tables');
            }
        }

        window.addEventListener('storage', (e) => {
            if (e.key === 'pos_tables') {
                const oldTables = JSON.parse(e.oldValue || '[]');
                const newTables = JSON.parse(e.newValue || '[]');

                oldTables.forEach(oldT => {
                    if (oldT.status !== STATUS.AVAILABLE) {
                        const newT = newTables.find(t => t.id === oldT.id);
                        if (newT && newT.status === STATUS.AVAILABLE) {
                            // Table was released
                            if (currentUser && currentUser.id === oldT.lockedBy) {
                                showToast('Table was released remotely. Redirecting...', 'info');
                                handleTableReleaseRedirect();
                            } else if (!currentUser) {
                                const lastUserId = localStorage.getItem('lastLoggedInUserId');
                                if (lastUserId && parseInt(lastUserId) === oldT.lockedBy) {
                                    handleTableReleaseRedirect(true);
                                }
                            }
                        }
                    }
                });
            }
        });

        // --- TABLE RELEASE MODAL HELPERS (see HTML modal below) ---
    </script>

    <!-- RELEASE TABLE CONFIRMATION MODAL -->
    <div id="release-table-modal"
        class="fixed inset-0 bg-black/60 z-[9999] hidden flex items-center justify-center backdrop-blur-sm p-4">
        <div id="release-modal-content"
            class="bg-white dark:bg-gray-900 w-full max-w-sm rounded-[2rem] shadow-2xl overflow-hidden transform scale-95 opacity-0 transition-all duration-300 border border-gray-100 dark:border-gray-700">

            <!-- Accent Header -->
            <div class="bg-gradient-to-br from-primary to-emerald-700 px-7 pt-7 pb-10 relative overflow-hidden">
                <div class="absolute -top-6 -right-6 w-28 h-28 bg-white/10 rounded-full"></div>
                <div class="absolute -bottom-4 -left-4 w-20 h-20 bg-white/10 rounded-full"></div>
                <div class="flex justify-between items-start relative z-10">
                    <div>
                        <div class="w-10 h-10 bg-white/20 rounded-xl flex items-center justify-center mb-3">
                            <i class="fa-solid fa-door-open text-white text-lg"></i>
                        </div>
                        <h2 class="text-2xl font-extrabold text-white" data-i18n="release_title">Release Table</h2>
                        <p class="text-white/80 text-sm mt-1" data-i18n="release_confirm_msg">Are you sure you want to
                            release this
                            table?</p>
                    </div>
                    <button onclick="closeReleaseModal()"
                        class="w-9 h-9 bg-white/20 hover:bg-white/30 rounded-xl flex items-center justify-center text-white transition-colors">
                        <i class="fa-solid fa-xmark text-lg"></i>
                    </button>
                </div>
            </div>

            <!-- Body -->
            <div class="-mt-6 bg-white dark:bg-gray-900 rounded-t-[2rem] px-7 pt-6 pb-7 space-y-5">
                <!-- Warning note -->
                <div
                    class="flex items-start gap-3 bg-green-50 dark:bg-green-900/20 border border-green-100 dark:border-green-800/40 rounded-2xl p-4">
                    <i class="fa-solid fa-triangle-exclamation text-green-500 mt-0.5 flex-shrink-0"></i>
                    <p class="text-sm text-green-700 dark:text-green-300 font-semibold leading-snug"
                        data-i18n="release_confirm_sub">
                        Unsaved items will be lost.</p>
                </div>

                <!-- Action Buttons -->
                <div class="flex gap-3">
                    <button onclick="closeReleaseModal()"
                        class="flex-1 py-3.5 rounded-xl border-2 border-gray-200 dark:border-gray-700 text-gray-600 dark:text-gray-300 font-bold hover:bg-gray-100 dark:hover:bg-gray-800 transition-all text-sm flex items-center justify-center gap-2">
                        <i class="fa-solid fa-arrow-left text-xs"></i>
                        <span data-i18n="release_keep">Keep Table</span>
                    </button>
                    <button onclick="confirmReleaseTable()"
                        class="flex-1 py-3.5 rounded-xl bg-primary hover:bg-emerald-600 text-white font-bold shadow-lg shadow-primary/30 hover:shadow-xl hover:shadow-primary/40 transition-all active:scale-95 text-sm flex items-center justify-center gap-2">
                        <i class="fa-solid fa-door-open"></i>
                        <span data-i18n="release_yes">Yes, Release</span>
                    </button>
                </div>
            </div>
        </div>
    </div>

</body>

</html>